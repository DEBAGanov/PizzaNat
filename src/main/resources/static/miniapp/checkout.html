<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DIMBO Pizza - –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
    
    <!-- Telegram WebApp API (–ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è 7.7) -->
    <script src="telegram-web-app.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="checkout-styles.css">
    
    <!-- Meta for Telegram -->
    <meta name="telegram-bot-username" content="DIMBOpizzaBot">
    <meta name="theme-color" content="#1a1a1a">
</head>
<body class="telegram-theme checkout-page">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞...</div>
    </div>

    <!-- App Container -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <button class="back-button" id="back-button">‚Üê –ù–∞–∑–∞–¥</button>
                <span class="header-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Delivery Options -->
            <section class="delivery-section">
                <h3>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</h3>
                <div class="delivery-options">
                    <label class="option-card">
                        <input type="radio" name="deliveryMethod" value="DELIVERY" id="delivery-courier" checked>
                        <div class="option-content">
                            <div class="option-title">üöó –î–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º</div>
                            <div class="option-subtitle">–î–æ—Å—Ç–∞–≤–∏–º –ø–æ –∞–¥—Ä–µ—Å—É</div>
                            <div class="option-price" id="delivery-price">‚ÇΩ200</div>
                        </div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="deliveryMethod" value="PICKUP" id="pickup-option">
                        <div class="option-content">
                            <div class="option-title">üè™ –°–∞–º–æ–≤—ã–≤–æ–∑</div>
                            <div class="option-subtitle">–ó–∞–±—Ä–∞—Ç—å –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
                            <div class="option-price">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
                        </div>
                    </label>
                </div>

                <!-- Address Input (shown by default for delivery) -->
                <div class="address-section" id="address-section">
                    <h4>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h4>
                    <div class="address-input-container">
                        <input type="text" 
                               id="address-input" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏..."
                               class="address-input">
                        <div class="address-suggestions" id="address-suggestions"></div>
                    </div>
                    <div class="address-note">
                        <small>–£–∫–∞–∂–∏—Ç–µ —É–ª–∏—Ü—É –∏ –¥–æ–º. –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–π–æ–Ω–∞.</small>
                    </div>
                </div>
            </section>

            <!-- Payment Options -->
            <section class="payment-section">
                <h3>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
                <div class="payment-options">
                    <label class="option-card">
                        <input type="radio" name="paymentMethod" value="SBP" id="payment-sbp" checked>
                        <div class="option-content">
                            <div class="option-title">üí≥ –°–ë–ü (–ë—ã—Å—Ç—Ä–∞—è –æ–ø–ª–∞—Ç–∞)</div>
                            <div class="option-subtitle">–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –±–∞–Ω–∫–æ–≤—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
                        </div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="paymentMethod" value="CASH" id="payment-cash">
                        <div class="option-content">
                            <div class="option-title">üíµ –ù–∞–ª–∏—á–Ω—ã–º–∏</div>
                            <div class="option-subtitle">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</div>
                        </div>
                    </label>
                </div>
            </section>

            <!-- Order Summary -->
            <section class="order-summary">
                <h2>–í–∞—à –∑–∞–∫–∞–∑</h2>
                <div class="order-items" id="order-items">
                    <!-- Order items will be loaded here -->
                </div>
                <div class="order-total">
                    <span>–¢–æ–≤–∞—Ä—ã: <span id="items-total">‚ÇΩ0</span></span>
                    <span class="delivery-cost">–î–æ—Å—Ç–∞–≤–∫–∞: <span id="delivery-cost">‚ÇΩ0</span></span>
                    <div class="total-amount">–ò—Ç–æ–≥–æ: <span id="total-amount">‚ÇΩ0</span></div>
                </div>
            </section>

            <!-- User Info Section (from auth) -->
            <section class="user-info-section">
                <h3>–ü–æ–ª—É—á–∞—Ç–µ–ª—å –∑–∞–∫–∞–∑–∞</h3>
                <div class="user-info-display" id="user-info-display">
                    <div class="user-name" id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="user-phone" id="user-phone">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="comment-section">
                    <textarea id="order-comment" 
                              placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" 
                              class="comment-textarea"></textarea>
                </div>
            </section>

            <!-- Submit Button -->
            <div class="submit-section">
                <button class="submit-button" id="submit-order">
                    –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ <span id="final-total">‚ÇΩ0</span>
                </button>
            </div>
        </main>
    </div>

    <!-- Error Screen -->
    <div id="error-screen" class="error-screen" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-message" id="error-message">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</div>
        <button class="retry-button" id="retry-button">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
    </div>

    <!-- Scripts -->
    <script src="api.js"></script>
    <script src="checkout-app.js"></script>
    <script>
        // Debug logging
        console.log('üîß DEBUG: Script loaded, checking dependencies...');
        console.log('üîß DEBUG: Telegram WebApp available:', !!window.Telegram?.WebApp);
        if (window.Telegram?.WebApp) {
            console.log('üîß DEBUG: Telegram WebApp VERSION:', window.Telegram.WebApp.version);
            console.log('üîß DEBUG: Telegram WebApp PLATFORM:', window.Telegram.WebApp.platform);
        }
        console.log('üîß DEBUG: PizzaAPI class available:', !!window.PizzaAPI);
        console.log('üîß DEBUG: PizzaNatCheckoutApp class available:', !!window.PizzaNatCheckoutApp);
        
        // Error handler for debugging
        window.addEventListener('error', (e) => {
            console.error('üö® Global error:', e.error);
            console.error('üö® Error details:', e.message, e.filename, e.lineno);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            const errorScreen = document.getElementById('error-screen');
            const errorMessage = document.getElementById('error-message');
            if (errorScreen && errorMessage) {
                errorMessage.textContent = `–û—à–∏–±–∫–∞: ${e.message} –≤ ${e.filename}:${e.lineno}`;
                errorScreen.style.display = 'flex';
            }
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (e) => {
            console.error('üö® Unhandled promise rejection:', e.reason);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            const errorScreen = document.getElementById('error-screen');
            const errorMessage = document.getElementById('error-message');
            if (errorScreen && errorMessage) {
                errorMessage.textContent = `Promise error: ${e.reason?.message || e.reason}`;
                errorScreen.style.display = 'flex';
            }
        });
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
        function initializeApp() {
            console.log('üîß DEBUG: Starting app initialization...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–ª–∞—Å—Å–æ–≤
            if (typeof PizzaNatCheckoutApp === 'undefined') {
                throw new Error('PizzaNatCheckoutApp class not found');
            }
            
            if (typeof PizzaAPI === 'undefined') {
                console.warn('‚ö†Ô∏è PizzaAPI class not found, will be created in app');
            }
            
            try {
                console.log('üîß DEBUG: Creating PizzaNatCheckoutApp...');
                const app = new PizzaNatCheckoutApp();
                console.log('üîß DEBUG: App created successfully:', app);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                window.checkoutApp = app;
            } catch (error) {
                console.error('üö® Failed to create app:', error);
                console.error('üö® Error stack:', error.stack);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –æ—à–∏–±–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                const errorScreen = document.getElementById('error-screen');
                const errorMessage = document.getElementById('error-message');
                if (errorScreen && errorMessage) {
                    errorMessage.textContent = `–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`;
                    errorScreen.style.display = 'flex';
                }
                
                throw error;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üîß DEBUG: DOMContentLoaded fired');
                setTimeout(initializeApp, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
            });
        } else {
            console.log('üîß DEBUG: DOM already ready');
            setTimeout(initializeApp, 100);
        }
    </script>
</body>
</html>
