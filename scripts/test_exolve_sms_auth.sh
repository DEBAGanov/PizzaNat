#!/bin/bash

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SMS –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Exolve API
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É SMS –∫–æ–¥–∞ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è –Ω–æ–º–µ—Ä–∞ +7 906 138-28-68

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
#BASE_URL="https://debaganov-pizzanat-0177.twc1.net"
BASE_URL="http://localhost:8080"
TEST_PHONE="+79061382868"  # –í–∞—à —Ç–µ—Å—Ç–æ–≤—ã–π –Ω–æ–º–µ—Ä
EXOLVE_SENDER="+79304410750"  # –ù–æ–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
EXOLVE_TOKEN="eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJRV05sMENiTXY1SHZSV29CVUpkWjVNQURXSFVDS0NWODRlNGMzbEQtVHA0In0.eyJleHAiOjIwNjU1MTM0MTMsImlhdCI6MTc1MDE1MzQxMywianRpIjoiMzIyNDBhZTAtNzU2Ni00NDhkLWEzZGUtYjFjZDBjODlkNTU0IiwiaXNzIjoiaHR0cHM6Ly9zc28uZXhvbHZlLnJ1L3JlYWxtcy9FeG9sdmUiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiZDZkYjE4ZDEtOWRhNS00NjRmLWI0ODYtMjI5NGQzMDk2ODI5IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiY2IxNGFjMTQtODU4OS00MjkzLWJkZjktNGE3M2VkYTRmMzQxIiwic2Vzc2lvbl9zdGF0ZSI6ImUzM2EwYzY1LWFkYTctNGU1My1iYmRmLTQzNDJhNTk0OTE1OCIsImFjciI6IjEiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy1leG9sdmUiLCJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJleG9sdmVfYXBwIHByb2ZpbGUgZW1haWwiLCJzaWQiOiJlMzNhMGM2NS1hZGE3LTRlNTMtYmJkZi00MzQyYTU5NDkxNTgiLCJ1c2VyX3V1aWQiOiI4NDY2MzRkNy0zYTNlLTRiMzMtODdkNy01MDgzZGRlNmYxOWIiLCJjbGllbnRJZCI6ImNiMTRhYzE0LTg1ODktNDI5My1iZGY5LTRhNzNlZGE0ZjM0MSIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwiY2xpZW50SG9zdCI6IjE3Mi4xNi4xNjEuMTkiLCJhcGlfa2V5Ijp0cnVlLCJhcGlmb25pY2Ffc2lkIjoiY2IxNGFjMTQtODU4OS00MjkzLWJkZjktNGE3M2VkYTRmMzQxIiwiYmlsbGluZ19udW1iZXIiOiIxMzMyNTgzIiwiYXBpZm9uaWNhX3Rva2VuIjoiYXV0ZDJlYTgxNGItMWM4Zi00ODRkLWE0MjgtMjY5YTZjOWM2NmY2IiwicHJlZmVycmVkX3VzZXJuYW1lIjoic2VydmljZS1hY2NvdW50LWNiMTRhYzE0LTg1ODktNDI5My1iZGY5LTRhNzNlZGE0ZjM0MSIsImN1c3RvbWVyX2lkIjoiMTM1ODk5IiwiY2xpZW50QWRkcmVzcyI6IjE3Mi4xNi4xNjEuMTkifQ.AFj1waE8M77SL26g9poSbRYEWeiV9Wy2ZonUnI4JJDF4uBP1D90YjTUOayHCPRbryBp6gU-cszAndQMlQsT5JLNhs88X7uo08XTY52Q9ghfdpEH22uG5AFxtWTr5450TfgLyl38goA76Xpd88xu3SHUJFEaScSGUjLaoZ1TKmvDnzdG1ZExtiARhUNRQ0eqlfkkfmYDiq_injddMk1Qub6TfC4zH4O2C0o4rUr9hIruXZe9ciKZAzZ_2hdys52vV8dN99OY5ghVRyysPAo05lScPDDMEpT2F6BwfZEQSH8r7WqOU3acxSI64gqmOFTczGZlsE7o09b_NlehqXIuHDg"

echo -e "${BLUE}üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï SMS –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ß–ï–†–ï–ó EXOLVE API${NC}"
echo -e "${BLUE}=================================================${NC}"
echo ""
echo -e "${YELLOW}üì± –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:${NC}"
echo -e "   üìû –ù–æ–º–µ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è: ${TEST_PHONE}"
echo -e "   üì§ –ù–æ–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: ${EXOLVE_SENDER}"
echo -e "   üîó –°–µ—Ä–≤–µ—Ä: ${BASE_URL}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
echo -e "${BLUE}1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞...${NC}"
if curl -s --max-time 10 "${BASE_URL}/actuator/health" > /dev/null; then
    echo -e "${GREEN}‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
else
    echo -e "${RED}‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
    exit 1
fi

# –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ SMS API —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
echo -e "${BLUE}2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º SMS API —ç–Ω–¥–ø–æ–∏–Ω—Ç...${NC}"
test_response=$(curl -s -o /dev/null -w "%{http_code}" "${BASE_URL}/api/v1/auth/sms/test")
if [ "$test_response" = "200" ]; then
    echo -e "${GREEN}‚úÖ SMS API —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è SMS API —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤–µ—Ä–Ω—É–ª –∫–æ–¥: $test_response${NC}"
fi

# –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–∫–∞ SMS –∫–æ–¥–∞
echo ""
echo -e "${BLUE}3Ô∏è‚É£ –≠–¢–ê–ü 1: –û—Ç–ø—Ä–∞–≤–∫–∞ SMS –∫–æ–¥–∞ –Ω–∞ –Ω–æ–º–µ—Ä ${TEST_PHONE}...${NC}"

send_code_response=$(curl -s -X POST "${BASE_URL}/api/v1/auth/sms/send-code" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -w "\n%{http_code}" \
  -d "{
    \"phoneNumber\": \"${TEST_PHONE}\"
  }")

# –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –∏ HTTP –∫–æ–¥
send_code_status=$(echo "$send_code_response" | tail -n 1)
send_code_body=$(echo "$send_code_response" | sed '$d')

echo -e "${YELLOW}üì§ –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏: HTTP $send_code_status${NC}"
echo -e "${YELLOW}üìù –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:${NC}"
echo "$send_code_body" | jq '.' 2>/dev/null || echo "$send_code_body"

if [ "$send_code_status" = "200" ]; then
    success=$(echo "$send_code_body" | jq -r '.success // false' 2>/dev/null)
    if [ "$success" = "true" ]; then
        echo -e "${GREEN}‚úÖ SMS –∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!${NC}"
        expires_at=$(echo "$send_code_body" | jq -r '.expiresAt // ""' 2>/dev/null)
        code_length=$(echo "$send_code_body" | jq -r '.codeLength // ""' 2>/dev/null)
        masked_phone=$(echo "$send_code_body" | jq -r '.maskedPhoneNumber // ""' 2>/dev/null)

        echo -e "${BLUE}üìã –î–µ—Ç–∞–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏:${NC}"
        echo -e "   üì± –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä: $masked_phone"
        echo -e "   üî¢ –î–ª–∏–Ω–∞ –∫–æ–¥–∞: $code_length —Å–∏–º–≤–æ–ª–æ–≤"
        echo -e "   ‚è∞ –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: $expires_at"

        # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ –∫–æ–¥–∞
        echo ""
        echo -e "${YELLOW}üì± –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SMS –Ω–∞ –Ω–æ–º–µ—Ä–µ ${TEST_PHONE}${NC}"
        echo -e "${BLUE}4Ô∏è‚É£ –≠–¢–ê–ü 2: –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏...${NC}"

        while true; do
            echo -n "–í–≤–µ–¥–∏—Ç–µ SMS –∫–æ–¥: "
            read -r sms_code

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–¥–∞
            if [[ "$sms_code" =~ ^[0-9]{4}$ ]]; then
                break
            else
                echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 4 —Ü–∏—Ñ—Ä${NC}"
            fi
        done

        # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è SMS –∫–æ–¥–∞
        echo -e "${BLUE}üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º SMS –∫–æ–¥: $sms_code...${NC}"

        verify_code_response=$(curl -s -X POST "${BASE_URL}/api/v1/auth/sms/verify-code" \
          -H "Content-Type: application/json" \
          -H "Accept: application/json" \
          -w "\n%{http_code}" \
          -d "{
            \"phoneNumber\": \"${TEST_PHONE}\",
            \"code\": \"${sms_code}\"
          }")

        # –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –∏ HTTP –∫–æ–¥
        verify_code_status=$(echo "$verify_code_response" | tail -n 1)
        verify_code_body=$(echo "$verify_code_response" | sed '$d')

        echo -e "${YELLOW}üîê –°—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: HTTP $verify_code_status${NC}"
        echo -e "${YELLOW}üìù –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:${NC}"
        echo "$verify_code_body" | jq '.' 2>/dev/null || echo "$verify_code_body"

        if [ "$verify_code_status" = "200" ]; then
            token=$(echo "$verify_code_body" | jq -r '.token // ""' 2>/dev/null)
            user_id=$(echo "$verify_code_body" | jq -r '.userId // ""' 2>/dev/null)
            username=$(echo "$verify_code_body" | jq -r '.username // ""' 2>/dev/null)

            if [ "$token" != "null" ] && [ "$token" != "" ]; then
                echo -e "${GREEN}üéâ SMS –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê!${NC}"
                echo -e "${BLUE}üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:${NC}"
                echo -e "   üÜî ID: $user_id"
                echo -e "   üë§ Username: $username"
                echo -e "   üîë JWT Token: ${token:0:50}..."

                # –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                echo ""
                echo -e "${BLUE}5Ô∏è‚É£ –≠–¢–ê–ü 3: –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å...${NC}"

                profile_response=$(curl -s -X GET "${BASE_URL}/api/v1/user/profile" \
                  -H "Authorization: Bearer $token" \
                  -H "Accept: application/json" \
                  -w "\n%{http_code}")

                profile_status=$(echo "$profile_response" | tail -n 1)
                profile_body=$(echo "$profile_response" | sed '$d')

                if [ "$profile_status" = "200" ]; then
                    echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω!${NC}"
                    echo -e "${YELLOW}üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:${NC}"
                    echo "$profile_body" | jq '.' 2>/dev/null || echo "$profile_body"
                else
                    echo -e "${YELLOW}‚ö†Ô∏è –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª –∫–æ–¥: $profile_status${NC}"
                    echo "$profile_body"
                fi

            else
                echo -e "${RED}‚ùå –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å - —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω${NC}"
            fi
        else
            echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ SMS –∫–æ–¥–∞${NC}"
        fi

    else
        error_message=$(echo "$send_code_body" | jq -r '.message // "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"' 2>/dev/null)
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS: $error_message${NC}"
    fi
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS (HTTP $send_code_status)${NC}"
fi

# –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç Exolve API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo ""
echo -e "${BLUE}6Ô∏è‚É£ –ë–û–ù–£–°: –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç Exolve API...${NC}"
echo -e "${YELLOW}üîß –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Exolve API...${NC}"

exolve_test_response=$(curl -s -X POST "https://api.exolve.ru/messaging/v1/SendSMS" \
  -H "Authorization: Bearer $EXOLVE_TOKEN" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -w "\n%{http_code}" \
  -d "{
    \"number\": \"${EXOLVE_SENDER}\",
    \"destination\": \"${TEST_PHONE}\",
    \"text\": \"PizzaNat TEST: –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç Exolve API –≤ $(date '+%H:%M:%S')\"
  }")

exolve_test_status=$(echo "$exolve_test_response" | tail -n 1)
exolve_test_body=$(echo "$exolve_test_response" | sed '$d')

echo -e "${YELLOW}üì° –°—Ç–∞—Ç—É—Å –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ Exolve: HTTP $exolve_test_status${NC}"
echo -e "${YELLOW}üìù –û—Ç–≤–µ—Ç Exolve API:${NC}"
echo "$exolve_test_body" | jq '.' 2>/dev/null || echo "$exolve_test_body"

if [ "$exolve_test_status" = "200" ]; then
    echo -e "${GREEN}‚úÖ –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Exolve API —Ä–∞–±–æ—Ç–∞–µ—Ç!${NC}"
else
    echo -e "${RED}‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä—è–º—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Exolve API${NC}"
fi

echo ""
echo -e "${BLUE}üìã –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø SMS –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò${NC}"
echo -e "${BLUE}===========================================${NC}"
echo -e "üì± –ù–æ–º–µ—Ä: ${TEST_PHONE}"
echo -e "üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: ${EXOLVE_SENDER}"
echo -e "üåê –°–µ—Ä–≤–µ—Ä: ${BASE_URL}"
echo -e "üïí –í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: $(date)"
echo ""