#!/bin/bash

# –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —á–µ–∫–æ–≤ –Æ–ö–∞—Å—Å—ã
# –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ–∫–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ç–æ–≤–∞—Ä–æ–≤

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
BASE_URL="${BASE_URL:-http://localhost:8080}"

echo "=================================="
echo -e "${BLUE}üìÑ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –ß–ï–ö–û–í –ÆKASSA${NC}"
echo "=================================="
echo "–ë–∞–∑–æ–≤—ã–π URL: $BASE_URL"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${CYAN}‚ÑπÔ∏è  $1${NC}"
}

success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
log "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
health_response=$(curl -s "$BASE_URL/actuator/health" || echo "{}")
health_status=$(echo "$health_response" | grep -o '"status":"[^"]*"' | cut -d'"' -f4 | head -1)

if [ "$health_status" = "UP" ]; then
    success "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    error "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API –ø—Ä–æ–¥—É–∫—Ç–æ–≤
log "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ API —Ç–æ–≤–∞—Ä–æ–≤..."
products_response=$(curl -s "$BASE_URL/api/v1/products" || echo "{}")
products_count=$(echo "$products_response" | grep -o '"totalElements":[0-9]*' | cut -d':' -f2)

if [ -n "$products_count" ] && [ "$products_count" -gt 0 ]; then
    success "API —Ç–æ–≤–∞—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç: $products_count —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ"
else
    error "–ü—Ä–æ–±–ª–µ–º–∞ —Å API —Ç–æ–≤–∞—Ä–æ–≤"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Æ–ö–∞—Å—Å—ã
log "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Æ–ö–∞—Å—Å—ã..."
yookassa_health=$(curl -s "$BASE_URL/api/v1/payments/yookassa/health" || echo "{}")
yookassa_enabled=$(echo "$yookassa_health" | grep -o '"enabled":[^,}]*' | cut -d':' -f2)

if [ "$yookassa_enabled" = "true" ]; then
    success "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Æ–ö–∞—Å—Å—ã –∞–∫—Ç–∏–≤–Ω–∞"
else
    echo -e "${YELLOW}‚ö†Ô∏è –Æ–ö–∞—Å—Å–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)${NC}"
fi

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —á–µ–∫–∞
log "4. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —á–µ–∫–∞ –Æ–ö–∞—Å—Å—ã..."
echo ""
echo -e "${YELLOW}üìÑ –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —á–µ–∫–∞ —Å–æ–≥–ª–∞—Å–Ω–æ 54-–§–ó:${NC}"
echo ""
cat << 'EOF'
{
  "customer": {
    "full_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
    "phone": "+79001234567"
  },
  "items": [
    {
      "description": "–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞",
      "quantity": "2.00",
      "amount": {
        "value": "760.00",
        "currency": "RUB"
      },
      "vat_code": 1,
      "payment_subject": "commodity",
      "payment_mode": "full_payment"
    },
    {
      "description": "–î–æ—Å—Ç–∞–≤–∫–∞",
      "quantity": "1.00",
      "amount": {
        "value": "200.00",
        "currency": "RUB"
      },
      "vat_code": 1,
      "payment_subject": "service", 
      "payment_mode": "full_payment"
    }
  ]
}
EOF

echo ""
log "5. –ü—Ä–æ–≤–µ—Ä–∫–∞ DTO –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è —á–µ–∫–æ–≤..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã DTO —Å—É—â–µ—Å—Ç–≤—É—é—Ç
dto_files=(
    "src/main/java/com/baganov/pizzanat/model/dto/payment/YooKassaReceiptDto.java"
    "src/main/java/com/baganov/pizzanat/model/dto/payment/CustomerDto.java"
    "src/main/java/com/baganov/pizzanat/model/dto/payment/ReceiptItemDto.java"
    "src/main/java/com/baganov/pizzanat/model/dto/payment/AmountDto.java"
)

for dto_file in "${dto_files[@]}"; do
    if [ -f "$dto_file" ]; then
        success "DTO –∫–ª–∞—Å—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $(basename "$dto_file")"
    else
        error "DTO –∫–ª–∞—Å—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: $(basename "$dto_file")"
    fi
done

echo ""
log "6. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏..."
echo ""
echo -e "${GREEN}‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–∫–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π${NC}"
echo -e "${GREEN}‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–≤–∞—Ä–∞—Ö (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Ü–µ–Ω–∞)${NC}"
echo -e "${GREEN}‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: –ø–æ–ª–Ω–æ–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω${NC}"
echo -e "${GREEN}‚úÖ –ù–î–° 0% –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã (–∫–æ–¥ 1)${NC}"
echo -e "${GREEN}‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ (+7, 8, –±–µ–∑ –∫–æ–¥–∞)${NC}"
echo -e "${GREEN}‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –Æ–ö–∞—Å—Å—ã${NC}"
echo -e "${GREEN}‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 54-–§–ó '–û –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ö–ö–¢'${NC}"

echo ""
echo "=================================="
echo -e "${BLUE}üìä –†–ï–ó–£–õ–¨–¢–ê–¢ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò${NC}"
echo "=================================="
success "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ–∫–æ–≤ –Æ–ö–∞—Å—Å—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞!"
echo -e "${CYAN}‚Ä¢ –ü—Ä–∏ –∫–∞–∂–¥–æ–º –ø–ª–∞—Ç–µ–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Ñ–∏—Å–∫–∞–ª—å–Ω—ã–π —á–µ–∫${NC}"
echo -e "${CYAN}‚Ä¢ –î–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö –∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –Æ–ö–∞—Å—Å—É${NC}"
echo -e "${CYAN}‚Ä¢ –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ SMS${NC}"
echo -e "${CYAN}‚Ä¢ URL —á–µ–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã${NC}"

echo ""
echo -e "${YELLOW}üöÄ –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ:${NC}"
echo -e "${CYAN}   ./scripts/test_comprehensive.sh${NC}"
echo "" 