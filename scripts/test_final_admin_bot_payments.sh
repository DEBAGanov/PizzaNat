#!/bin/bash

echo "üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π –≤ –∞–¥–º–∏–Ω—Å–∫–∏–π –±–æ—Ç"
echo "=============================================================="

BASE_URL="http://localhost:8080/api/v1"

# –ü–æ–ª—É—á–µ–Ω–∏–µ admin —Ç–æ–∫–µ–Ω–∞
echo "üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞..."
admin_auth_response=$(curl -s -X POST "$BASE_URL/auth/login" \
    -H "Content-Type: application/json" \
    -d '{"username":"admin","password":"admin123"}')

admin_token=$(echo "$admin_auth_response" | jq -r '.token // empty')

if [ -z "$admin_token" ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
    exit 1
fi

echo "‚úÖ –¢–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ–ª—É—á–µ–Ω"

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
echo ""
echo "üìã 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ API"
active_orders_response=$(curl -s "$BASE_URL/admin/orders/active" \
    -H "Authorization: Bearer $admin_token")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫—É
if echo "$active_orders_response" | grep -q '"status":500'; then
    echo "‚ùå –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤"
    echo "$active_orders_response"
    exit 1
fi

echo "‚úÖ API –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
echo "üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã:"
echo "$active_orders_response" | jq -r '.[0:3] | .[] | "‚Ä¢ –ó–∞–∫–∞–∑ #\(.id) - \(.contactName) - \(.totalAmount) —Ä—É–± (\(.status))"'

# –ü–æ–ª—É—á–∞–µ–º ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
latest_order_id=$(echo "$active_orders_response" | jq -r '.[0].id // empty')

if [ -n "$latest_order_id" ]; then
    echo ""
    echo "üîç 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ #$latest_order_id"
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
    order_details_response=$(curl -s "$BASE_URL/admin/orders/$latest_order_id" \
        -H "Authorization: Bearer $admin_token")
    
    echo "üìÑ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞:"
    echo "$order_details_response" | jq -r '"–ó–∞–∫–∞–∑: \(.contactName), –°—É–º–º–∞: \(.totalAmount) —Ä—É–±, –°—Ç–∞—Ç—É—Å: \(.status)"'
    
    echo ""
    echo "üí∞ 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞–∫–∞–∑–∞ #$latest_order_id"
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞–∫–∞–∑–∞
    payments_response=$(curl -s "$BASE_URL/payments/yookassa/order/$latest_order_id" \
        -H "Authorization: Bearer $admin_token")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
    payment_count=$(echo "$payments_response" | jq '. | length')
    
    if [ "$payment_count" -gt 0 ]; then
        echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ $payment_count –ø–ª–∞—Ç–µ–∂(–µ–π) –¥–ª—è –∑–∞–∫–∞–∑–∞ #$latest_order_id"
        echo "üí≥ –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π:"
        echo "$payments_response" | jq -r '.[] | "‚Ä¢ –ü–ª–∞—Ç–µ–∂ #\(.id) - \(.method) - \(.status) - \(.amount) —Ä—É–±"'
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–ª–∞—Ç–µ–∂–µ–π
        echo ""
        echo "üîó –°—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:"
        echo "$payments_response" | jq -r '.[] | select(.yookassaPaymentId != null) | "‚Ä¢ https://yoomoney.ru/checkout/payments/v2/contract?orderId=\(.yookassaPaymentId)"'
        
        echo ""
        echo "üéâ –†–ï–ó–£–õ–¨–¢–ê–¢: –ó–∞–∫–∞–∑ #$latest_order_id –ò–ú–ï–ï–¢ –ø–ª–∞—Ç–µ–∂–∏"
        echo "   –í –∞–¥–º–∏–Ω—Å–∫–æ–º –±–æ—Ç–µ –î–û–õ–ñ–ù–ê –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö"
        
    else
        echo "‚ö†Ô∏è  –ó–∞–∫–∞–∑ #$latest_order_id –ù–ï –∏–º–µ–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π (–Ω–∞–ª–∏—á–Ω—ã–π –∑–∞–∫–∞–∑)"
        echo "   –í –∞–¥–º–∏–Ω—Å–∫–æ–º –±–æ—Ç–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è '–ù–∞–ª–∏—á–Ω—ã–º–∏'"
    fi
else
    echo "‚ö†Ô∏è  –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
fi

echo ""
echo "ü§ñ –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –í TELEGRAM:"
echo "======================================"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∞–¥–º–∏–Ω—Å–∫–∏–π –±–æ—Ç"
echo "2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /orders –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤"
echo "3. –ù–∞–π–¥–∏—Ç–µ –∑–∞–∫–∞–∑ #$latest_order_id –≤ —Å–ø–∏—Å–∫–µ"
echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è:"
echo "   ‚Ä¢ –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ (‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã, ‚úÖ –û–ø–ª–∞—á–µ–Ω–æ, üíµ –ù–∞–ª–∏—á–Ω—ã–º–∏)"
echo "   ‚Ä¢ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (üì± –°–ë–ü, üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞, etc.)"
echo "   ‚Ä¢ –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–ª–∞—Ç–µ–∂–∞ (–¥–ª—è –æ–Ω–ª–∞–π–Ω –ø–ª–∞—Ç–µ–∂–µ–π)"
echo "5. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /details $latest_order_id –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π"
echo "6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–∞—Ö"
echo ""
echo "‚úÖ –ï—Å–ª–∏ –≤—Å–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!"
echo "‚ùå –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ '–ù–∞–ª–∏—á–Ω—ã–º–∏' - –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞" 