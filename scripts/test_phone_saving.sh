#!/bin/bash

# –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram

echo "üìû –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ +7 —Ñ–æ—Ä–º–∞—Ç–µ"
echo "========================================================"

BASE_URL="http://localhost:8080"

echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
if curl -s "${BASE_URL}/actuator/health" | grep -q "UP"; then
    echo "   ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "   ‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ"
    exit 1
fi

echo "2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
DEVICE_ID="test_phone_$(date +%s)"
response=$(curl -s -X POST "${BASE_URL}/api/v1/auth/telegram/init" \
    -H "Content-Type: application/json" \
    -d "{\"deviceId\":\"$DEVICE_ID\"}" 2>/dev/null)

if echo "$response" | grep -q "authToken"; then
    TOKEN=$(echo "$response" | jq -r '.authToken' 2>/dev/null)
    BOT_URL=$(echo "$response" | jq -r '.telegramBotUrl' 2>/dev/null)
    echo "   ‚úÖ –¢–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω: $TOKEN"
    echo "   ‚úÖ –°—Å—ã–ª–∫–∞: $BOT_URL"
else
    echo "   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞"
    exit 1
fi

echo ""
echo "üì± –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–û–ú–ï–†–ê –¢–ï–õ–ï–§–û–ù–ê:"
echo "==========================================="
echo ""
echo "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å:"
echo "   $BOT_URL"
echo ""
echo "2. –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –ë–î:"
echo ""

echo "–û–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..."
echo "(–Ω–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è)"

# –ñ–¥–µ–º 30 —Å–µ–∫—É–Ω–¥ –∏–ª–∏ –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∂–º–µ—Ç Ctrl+C
for i in {30..1}; do
    printf "\r   ‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: %2d —Å–µ–∫" $i
    sleep 1
done
echo ""

echo ""
echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞..."
if command -v docker &> /dev/null; then
    echo "   –ü–æ–∏—Å–∫ –ª–æ–≥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞..."

    # –ò—â–µ–º –ª–æ–≥–∏ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    phone_logs=$(docker logs pizzanat-app 2>&1 | grep -i "–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.*–æ–±–Ω–æ–≤–ª–µ–Ω\|phone.*updated\|formatPhoneNumber" | tail -5)

    if [ -n "$phone_logs" ]; then
        echo "   üìã –ù–∞–π–¥–µ–Ω—ã –ª–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞:"
        echo "$phone_logs" | while read line; do
            echo "      $line"
        done
    else
        echo "   ‚ö†Ô∏è  –õ–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi

    echo ""
    echo "   –ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."
    user_logs=$(docker logs pizzanat-app 2>&1 | grep -i "—Å–æ–∑–¥–∞–Ω.*–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\|user.*created" | tail -3)

    if [ -n "$user_logs" ]; then
        echo "   üìã –ù–∞–π–¥–µ–Ω—ã –ª–æ–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:"
        echo "$user_logs" | while read line; do
            echo "      $line"
        done
    fi

else
    echo "   Docker –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ª–æ–≥–æ–≤"
fi

echo ""
echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞:"
echo "   üìã –û–∂–∏–¥–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è:"
echo "      79169969633 ‚Üí +79169969633"
echo "      89169969633 ‚Üí +79169969633"
echo "      9169969633  ‚Üí +79169969633"
echo "      379169969633 ‚Üí +79169969633"
echo ""

echo "üéØ –†–ï–ó–£–õ–¨–¢–ê–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:"
echo "========================"
echo ""
echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ formatPhoneNumber –≤ TelegramAuthService"
echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ formatPhoneNumber –≤ TelegramUserDataExtractor"
echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ handleContactMessage - —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è updateUserWithPhone"
echo "‚úÖ –ù–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX"
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ë–î:"
echo "   SELECT username, phone, telegram_id FROM users WHERE phone IS NOT NULL;"
echo ""
echo "‚ùó –ï—Å–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤—Å–µ –µ—â–µ NULL:"
echo "   1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: docker compose restart"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker logs pizzanat-app -f | grep -i phone"
echo "   3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–æ–≤—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º"