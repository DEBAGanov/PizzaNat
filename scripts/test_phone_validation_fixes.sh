#!/bin/bash

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
# –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 27.01.2025

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î"
echo "==============================================================="

echo
echo "‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:"
echo "=========================="
echo "üîß Backend (TelegramWebAppService.java):"
echo "  - –£–ª—É—á—à–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ formatPhoneNumber()"
echo "  - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
echo "  - –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ isPhoneVerified –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞"
echo "  - –í–æ–∑–≤—Ä–∞—Ç null –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏"

echo
echo "üîß Frontend (checkout-app.js):"
echo "  - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ validatePhoneNumber() —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤"
echo "  - –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –æ—Ç requestContact() –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º"
echo "  - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π"
echo "  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ performEnhancedAuth() –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î"
echo "  - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –≤ +7XXXXXXXXXX —Ñ–æ—Ä–º–∞—Ç"

echo
echo "üì± –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–ú–´–ï –§–û–†–ú–ê–¢–´ –ù–û–ú–ï–†–û–í:"
echo "================================="
echo "‚úÖ +79161234567 (—É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)"
echo "‚úÖ 79161234567 (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è +)"
echo "‚úÖ 89161234567 (8 –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ +7)"
echo "‚úÖ 9161234567 (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è +7)"
echo "‚ùå –î—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º"

echo
echo "üîÑ –ü–û–¢–û–ö –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–û–ú–ï–†–ê:"
echo "=========================="
echo "1. üì± –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–æ–º–µ—Ä (requestContact –∏–ª–∏ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥)"
echo "2. ‚úÖ JavaScript –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
echo "3. üîê –í—ã–∑–æ–≤ performEnhancedAuth(formattedPhone)"
echo "4. üì° POST /api/v1/telegram-webapp/enhanced-auth"
echo "5. üîß Backend –≤–∞–ª–∏–¥–∞—Ü–∏—è formatPhoneNumber()"
echo "6. üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ users (phone, isPhoneVerified=true, isTelegramVerified=true)"
echo "7. üìã –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ telegram_auth_tokens"

echo
echo "üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ù–û–ú–ï–†–û–í:"
echo "========================"

# –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ (–∏–º–∏—Ç–∞—Ü–∏—è JavaScript)
test_phone_format() {
    local input="$1"
    local expected="$2"
    
    # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ +
    cleaned=$(echo "$input" | sed 's/[^0-9+]//g')
    digits_only=$(echo "$cleaned" | sed 's/[^0-9]//g')
    
    local result=""
    
    if [[ "$digits_only" =~ ^7.{10}$ ]]; then
        result="+$digits_only"
    elif [[ "$digits_only" =~ ^8.{10}$ ]]; then
        result="+7${digits_only:1}"
    elif [[ ${#digits_only} -eq 10 ]]; then
        result="+7$digits_only"
    elif [[ "$cleaned" =~ ^\+7 && ${#digits_only} -eq 11 ]]; then
        result="+$digits_only"
    else
        result="INVALID"
    fi
    
    if [ "$result" = "$expected" ]; then
        echo "  ‚úÖ '$input' ‚Üí '$result'"
    else
        echo "  ‚ùå '$input' ‚Üí '$result' (–æ–∂–∏–¥–∞–ª–æ—Å—å: '$expected')"
    fi
}

echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JavaScript –≤–∞–ª–∏–¥–∞—Ü–∏–∏:"
test_phone_format "+79161234567" "+79161234567"
test_phone_format "79161234567" "+79161234567"
test_phone_format "89161234567" "+79161234567"
test_phone_format "9161234567" "+79161234567"
test_phone_format "+7 916 123-45-67" "+79161234567"
test_phone_format "8 (916) 123-45-67" "+79161234567"
test_phone_format "123456789" "INVALID"
test_phone_format "+1234567890" "INVALID"

echo
echo "üåê –ü–†–û–í–ï–†–ö–ê API –≠–ù–î–ü–û–ò–ù–¢–û–í:"
echo "==========================="

BASE_URL="https://api.dimbopizza.ru"

echo "üîß Enhanced-auth —ç–Ω–¥–ø–æ–∏–Ω—Ç:"
enhanced_auth_status=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST $BASE_URL/api/v1/telegram-webapp/enhanced-auth \
    -H "Content-Type: application/json" \
    -d '{"initDataRaw": "test", "phoneNumber": "+79161234567", "deviceId": "test"}')

if [ "$enhanced_auth_status" = "400" ]; then
    echo "  ‚úÖ Enhanced-auth API –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $enhanced_auth_status - –æ–∂–∏–¥–∞–µ–º–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö)"
else
    echo "  ‚ùå Enhanced-auth API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $enhanced_auth_status)"
fi

echo
echo "üìã –ü–†–û–í–ï–†–ö–ê –í –ë–î –ü–û–°–õ–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:"
echo "===================================="
echo "–ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:"
echo
echo "1. –¢–∞–±–ª–∏—Ü–∞ users:"
echo "   SELECT id, username, phone, is_phone_verified, is_telegram_verified"
echo "   FROM users WHERE telegram_id IS NOT NULL"
echo "   ORDER BY updated_at DESC;"
echo
echo "2. –¢–∞–±–ª–∏—Ü–∞ telegram_auth_tokens:"
echo "   SELECT auth_token, telegram_id, status, created_at, expires_at"
echo "   FROM telegram_auth_tokens"
echo "   WHERE created_at > NOW() - INTERVAL '1 hour';"

echo
echo "üöÄ –ö–û–ú–ê–ù–î–´ –î–õ–Ø –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø:"
echo "============================"
echo "# –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
echo "docker-compose -f docker-compose.dev.yml up --build -d"
echo
echo "# –ü—Ä–æ–¥–∞–∫—à–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"
echo "docker-compose -f docker-compose.production.yml up --build -d"

echo
echo "üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:"
echo "======================"
echo "‚úÖ –ù–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –≤ +7XXXXXXXXXX"
echo "‚úÖ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º"
echo "‚úÖ –ù–æ–º–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ users –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç Telegram"
echo "‚úÖ –ù–æ–º–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ users –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ"
echo "‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Ñ–ª–∞–≥–∏ is_phone_verified –∏ is_telegram_verified"
echo "‚úÖ –°–æ–∑–¥–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ –≤ telegram_auth_tokens –¥–ª—è –∫—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞"

echo
echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!"
