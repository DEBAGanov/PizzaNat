#!/bin/bash

# –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram

echo "üë§ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
echo "====================================="

BASE_URL="http://localhost:8080"

echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
if curl -s "${BASE_URL}/actuator/health" | grep -q "UP"; then
    echo "   ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "   ‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ"
    exit 1
fi

echo "2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞..."
DEVICE_ID="test_user_creation_$(date +%s)"
response=$(curl -s -X POST "${BASE_URL}/api/v1/auth/telegram/init" \
    -H "Content-Type: application/json" \
    -d "{\"deviceId\":\"$DEVICE_ID\"}" 2>/dev/null)

if echo "$response" | grep -q "authToken"; then
    TOKEN=$(echo "$response" | jq -r '.authToken' 2>/dev/null)
    BOT_URL=$(echo "$response" | jq -r '.telegramBotUrl' 2>/dev/null)
    echo "   ‚úÖ –¢–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω: $TOKEN"
    echo "   ‚úÖ –°—Å—ã–ª–∫–∞: $BOT_URL"
else
    echo "   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞"
    echo "   –û—Ç–≤–µ—Ç: $response"
    exit 1
fi

echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ–∫–µ–Ω–∞..."
status_response=$(curl -s "${BASE_URL}/api/v1/auth/telegram/status/${TOKEN}" 2>/dev/null)
if echo "$status_response" | grep -q "PENDING"; then
    echo "   ‚úÖ –¢–æ–∫–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å–µ PENDING (–≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é)"
else
    echo "   ‚ö†Ô∏è  –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞"
    echo "   –û—Ç–≤–µ—Ç: $status_response"
fi

echo ""
echo "üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–û–ó–î–ê–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:"
echo "======================================="
echo ""
echo "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ:"
echo "   $BOT_URL"
echo ""
echo "2. –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:"
echo "   ‚úÖ –°—Ä–∞–∑—É –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ PizzaNat!'"
echo "   ‚úÖ –ö–Ω–æ–ø–∫–∞ 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω' –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è"
echo "   ‚úÖ –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞'"
echo ""
echo "3. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞:"
echo "   ‚úÖ –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—É—á–µ–Ω!'"
echo "   ‚úÖ –ó–∞—Ç–µ–º '–í—Ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!' –∏ '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!'"
echo "   ‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'"
echo ""

echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î..."
# –ü—Ä–æ–≤–µ—Ä–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ –∏ –ø–æ—Å–ª–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ë–î)
if command -v docker &> /dev/null; then
    echo "   –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
    echo "   (–õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50 —Å—Ç—Ä–æ–∫, –≥–¥–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)"

    docker logs pizzanat-app 2>&1 | grep -i "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.*—Å–æ–∑–¥–∞–Ω\|user.*created\|findOrCreateUser" | tail -10 | while read line; do
        echo "   üìã $line"
    done
else
    echo "   Docker –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ª–æ–≥–æ–≤"
fi

echo ""
echo "üèÅ –†–ï–ó–£–õ–¨–¢–ê–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:"
echo "========================"
echo ""
echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –°–†–ê–ó–£ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞"
echo "‚úÖ –ú–µ—Ç–æ–¥ createOrUpdateUser –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo "‚úÖ –ù–ï–¢ –æ—à–∏–±–∫–∏ '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'"
echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞"
echo ""
echo "üìû –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker logs pizzanat-app -f"