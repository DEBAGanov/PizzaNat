# PizzaNat - Трекер задач

## Содержание
1. [Текущие задачи](#текущие-задачи)
2. [Запланированные задачи](#запланированные-задачи)
3. [Завершенные задачи](#завершенные-задачи)

## Текущие задачи

### Модуль тестирования
- **Задача**: Настройка интеграционных тестов
  - **Статус**: В процессе
  - **Приоритет**: Высокий
  - **Описание**: Настройка и отладка интеграционных тестов для всех контроллеров приложения
  - **Шаги выполнения**:
    - [x] Настроить тестовые конфигурации (TestRedisConfig, TestMailConfig, TestS3Config)
    - [x] Настроить базовый класс для интеграционных тестов (BaseIntegrationTest)
    - [x] Исправить конфликты бинов путем добавления аннотации @Profile("!test") к основным конфигурациям
    - [x] Создать GlobalExceptionHandler для обработки исключений
    - [x] Успешно настроить тесты для AuthController
    - [x] Настроить тесты для CategoryController
    - [ ] Настроить тесты для CartController
    - [ ] Настроить тесты для ProductController
    - [ ] Настроить тесты для OrderController
    - [ ] Настроить тесты для PaymentController
  - **Зависимости**: Корректная работа основных контроллеров, настройка Spring Security

### Модуль аутентификации и авторизации
- **Задача**: Оптимизация JWT-аутентификации
  - **Статус**: В процессе
  - **Приоритет**: Высокий
  - **Описание**: Улучшение механизма обновления JWT-токенов и добавление возможности их отзыва
  - **Шаги выполнения**:
    - [x] Анализ текущей реализации JWT
    - [x] Выбор оптимального подхода для обновления токенов
    - [ ] Реализация механизма обновления токенов
    - [ ] Реализация механизма отзыва токенов
    - [ ] Написание тестов
  - **Зависимости**: -

### Модуль корзины
- **Задача**: Улучшение производительности корзины
  - **Статус**: В процессе
  - **Приоритет**: Средний
  - **Описание**: Оптимизация запросов и кэширование данных корзины
  - **Шаги выполнения**:
    - [x] Анализ текущих запросов к БД
    - [x] Определение узких мест
    - [ ] Оптимизация запросов
    - [ ] Настройка кэширования
    - [ ] Написание тестов
  - **Зависимости**: -

### Модуль изображений
- **Задача**: Исправление системы загрузки и отображения изображений
  - **Статус**: В процессе ✅
  - **Приоритет**: Высокий
  - **Описание**: Исправление проблем с загрузкой и отображением изображений продуктов и категорий
  - **Шаги выполнения**:
    - [x] Исправлен маппинг имен файлов в ImageUploader
    - [x] Унифицированы имена файлов (pizza_4_chees.png вместо pizza_4_cheese.png)
    - [x] Обновлена логика работы с S3/MinIO в разных окружениях
    - [x] Исправлена проблема с формированием URL для изображений
    - [ ] Тестирование загрузки изображений в prod окружении
    - [ ] Проверка корректности отображения всех изображений
  - **Технические детали**:
    - Исправлен конфликт имен файлов (4_chees vs 4_cheese)
    - Унифицирована работа с S3 в dev и prod окружениях
    - Обновлена конфигурация MinIO для корректной работы с публичными URL
  - **Зависимости**: Корректная работа StorageService, настройка MinIO/S3

## Запланированные задачи

### Модуль заказов
- **Задача**: Разработка механизма отслеживания заказа
  - **Статус**: Запланирована
  - **Приоритет**: Высокий
  - **Описание**: Реализация системы отслеживания статуса заказа в реальном времени
  - **Шаги выполнения**:
    - [ ] Разработка модели данных для событий заказа
    - [ ] Реализация API для получения обновлений
    - [ ] Интеграция с системой уведомлений
    - [ ] Написание тестов
  - **Зависимости**: Завершение задачи "Реализация системы уведомлений"

### Модуль платежей
- **Задача**: Интеграция с платежным шлюзом
  - **Статус**: Не начата
  - **Приоритет**: Высокий
  - **Описание**: Настройка интеграции с платежным шлюзом для обработки платежей
  - **Зависимости**: Аккаунт и API-ключи платежного шлюза

## Завершенные задачи

### Решение проблем со Swagger и запуском приложения
- **Задача**: Исправление конфликтов и ошибок при запуске
  - **Статус**: Завершена
  - **Приоритет**: Критический
  - **Описание**: Устранение проблем с запуском приложения и работой Swagger UI
  - **Выполненные шаги**:
    - [x] Устранен конфликт между HomeController и Swagger UI на корневом пути
    - [x] Обновлена версия SpringDoc с 2.5.0 до 2.7.0 для совместимости с Spring Boot 3.4.5
    - [x] Исправлена ошибка NoSuchMethodError в ControllerAdviceBean
    - [x] Добавлен /api/health в список разрешенных URL-адресов
    - [x] Обновлена конфигурация Nginx для использования имен сервисов Docker
    - [x] Удален устаревший OpenApiConfig.java и создан новый с правильной конфигурацией
    - [x] Упрощена конфигурация SpringDoc в application.properties
    - [x] Решена проблема "Unable to render this definition" путем правильной настройки версии OpenAPI 3.0.1
    - [x] Устранен конфликт дублирующих бинов OpenAPI между конфигурационными классами
    - [x] Исправлена проблема с кодировкой JSON в OpenAPI документации
  - **Результат**:
    - Приложение успешно запускается без ошибок
    - Swagger UI полностью функционален и доступен по http://localhost/swagger-ui/index.html
    - OpenAPI документация корректно отображается с версией 3.0.1
    - API документация содержит все необходимые endpoint'ы с правильными описаниями
    - Health endpoint доступен по http://localhost/api/health
    - Все проблемы с отображением Swagger UI решены

### Инфраструктура
- **Задача**: Настройка Docker-окружения
  - **Статус**: Завершена
  - **Описание**: Настройка docker-compose для локальной разработки
  - **Выполненные шаги**:
    - [x] Настройка PostgreSQL в Docker
    - [x] Настройка Redis в Docker
    - [x] Настройка MinIO в Docker
    - [x] Настройка Nginx для проксирования запросов

### Модуль авторизации
- **Задача**: Настройка JWT-аутентификации
  - **Статус**: Завершена
  - **Описание**: Настройка JWT-токенов для аутентификации пользователей
  - **Выполненные шаги**:
    - [x] Настройка JWT-секрета в конфигурации
    - [x] Реализация фильтра для проверки JWT-токенов
    - [x] Реализация сервисов для выдачи JWT-токенов
    - [x] Тестирование аутентификации

### Документация API
- **Задача**: Настройка Swagger UI
  - **Статус**: Завершена
  - **Описание**: Настройка Swagger UI для документирования API
  - **Выполненные шаги**:
    - [x] Добавление зависимостей SpringDoc
    - [x] Настройка Swagger UI
    - [x] Настройка Nginx для проксирования запросов к Swagger UI

### Модуль кэширования
- **Задача**: Настройка Redis для кэширования
  - **Статус**: Завершена
  - **Приоритет**: Высокий
  - **Описание**: Настройка и оптимизация кэширования с использованием Redis
  - **Шаги выполнения**:
    - [x] Настройка подключения к Redis
    - [x] Определение стратегии кэширования
    - [x] Реализация кэширования для ключевых запросов
    - [x] Написание тестов
  - **Зависимости**: -
  - **Дата завершения**: 2023-07-20

### Безопасность
- **Задача**: Реализация базовой JWT-аутентификации
  - **Статус**: Завершена
  - **Приоритет**: Высокий
  - **Описание**: Реализация JWT-аутентификации для API
  - **Шаги выполнения**:
    - [x] Разработка модели данных пользователей и ролей
    - [x] Реализация JWT-аутентификации
    - [x] Настройка ограничений доступа к API
    - [x] Написание тестов
  - **Зависимости**: -
  - **Дата завершения**: 2023-06-15

### Оптимизация конфигурации S3/MinIO
- **Статус**: Завершена ✅
- **Описание**: Улучшение конфигурации и работы с S3/MinIO хранилищем
- **Выполненные шаги**:
  - [x] Унифицирована конфигурация для dev и prod окружений
  - [x] Исправлены проблемы с формированием URL изображений
  - [x] Обновлен механизм загрузки изображений в StorageService
  - [x] Добавлена поддержка публичных URL для статических изображений
  - [x] Оптимизирована работа с MinIO в dev окружении
  - [x] Настроена корректная работа с Timeweb S3 в prod
- **Технические улучшения**:
  - Улучшена обработка ошибок при загрузке файлов
  - Добавлено логирование операций с файлами
  - Оптимизирована конфигурация для разных окружений
  - Исправлены проблемы с именами файлов и URL
- **Результат**:
  - Стабильная работа с изображениями в обоих окружениях
  - Корректное отображение изображений продуктов и категорий
  - Улучшенная производительность и надежность

## Задача: Инициализация проекта
- **Статус**: Завершена
- **Описание**: Создание базовой структуры проекта и настройка окружения
- **Шаги выполнения**:
  - [x] Создать базовую структуру Spring Boot проекта
  - [x] Настроить подключение к PostgreSQL
  - [x] Добавить базовые модели данных
  - [x] Настроить Spring Security и JWT
  - [x] Создать Docker Compose для локальной разработки
- **Зависимости**: -

## Задача: Реализация управления каталогом
- **Статус**: Завершена
- **Описание**: Разработка API для управления продуктами и категориями
- **Шаги выполнения**:
  - [x] Создать модели данных для продуктов и категорий
  - [x] Реализовать репозитории и сервисы
  - [x] Разработать REST API для CRUD-операций
  - [x] Добавить валидацию данных
  - [x] Настроить кэширование с использованием Redis
- **Зависимости**: Инициализация проекта

## Задача: Реализация системы корзины и заказов
- **Статус**: Завершена
- **Описание**: Разработка функциональности корзины и оформления заказов
- **Шаги выполнения**:
  - [x] Создать модели данных для корзины и заказов
  - [x] Реализовать бизнес-логику для добавления и удаления товаров
  - [x] Разработать процесс оформления заказа
  - [x] Добавить управление статусами заказов
  - [x] Реализовать уведомления о изменении статуса
- **Зависимости**: Реализация управления каталогом

## Задача: Интеграция с хранилищем изображений
- **Статус**: Завершена
- **Описание**: Настройка хранения и управления изображениями продуктов
- **Шаги выполнения**:
  - [x] Настроить MinIO для хранения изображений
  - [x] Разработать сервис для загрузки и получения изображений
  - [x] Интегрировать работу с изображениями в API продуктов
  - [x] Добавить функциональность миниатюр и оптимизации
  - [x] Настроить безопасный доступ к изображениям
- **Зависимости**: Реализация управления каталогом

## Задача: Административный интерфейс API
- **Статус**: Завершена
- **Описание**: Разработка API для административных функций
- **Шаги выполнения**:
  - [x] Создать контроллеры для администрирования пользователей
  - [x] Разработать управление заказами и статусами
  - [x] Добавить аналитику и формирование отчетов
  - [x] Настроить разграничение прав доступа
  - [x] Реализовать мониторинг системы
- **Зависимости**: Реализация системы корзины и заказов

## Задача: Повышение отказоустойчивости
- **Статус**: Завершена
- **Описание**: Внедрение механизмов для обеспечения стабильной работы при сбоях
- **Шаги выполнения**:
  - [x] Добавить Resilience4j для обеспечения отказоустойчивости
  - [x] Реализовать Circuit Breaker для внешних вызовов
  - [x] Настроить механизм повторных попыток (Retry)
  - [x] Создать абстрактный класс BaseResilientClient
  - [x] Настроить мониторинг состояния отказоустойчивости
- **Зависимости**: Административный интерфейс API

## Задача: Интеграция с платежной системой
- **Статус**: Завершена
- **Описание**: Реализация взаимодействия с платежной системой Robokassa
- **Шаги выполнения**:
  - [x] Создать клиент для взаимодействия с API Robokassa
  - [x] Реализовать процесс создания платежа и формирования URL
  - [x] Добавить обработку уведомлений от платежной системы
  - [x] Интегрировать платежи с системой заказов
  - [x] Настроить обработку ошибок и логирование
- **Зависимости**: Повышение отказоустойчивости

## Задача: Улучшение документации API
- **Статус**: Завершена
- **Описание**: Улучшение Swagger UI и документации API
- **Шаги выполнения**:
  - [x] Создать конфигурационный класс OpenApiConfig
  - [x] Настроить аутентификацию JWT в Swagger UI
  - [x] Добавить подробные описания для всех API эндпоинтов
  - [x] Создать примеры запросов и ответов
  - [x] Обновить документацию в соответствии с изменениями
- **Зависимости**: Интеграция с платежной системой

## Задача: Расширение и кастомизация Swagger UI
- **Статус**: Завершена
- **Описание**: Создание расширенной конфигурации и кастомизация интерфейса Swagger UI для улучшения документации API
- **Шаги выполнения**:
  - [x] Обновление класса OpenApiConfig с добавлением группировки API
  - [x] Создание кастомного CSS для брендирования интерфейса
  - [x] Создание кастомного HTML-шаблона для Swagger UI
  - [x] Разработка SwaggerController для перенаправления на кастомный UI
  - [x] Обновление настроек SpringDoc в application.properties
  - [x] Настройка кэширования статических ресурсов в Nginx
  - [x] Тестирование работы Swagger UI через Nginx
- **Зависимости**: SpringDoc OpenAPI, Spring Web

## Задача: Исправление проблем в Docker-контейнерах
- **Статус**: Завершена
- **Описание**: Исправление проблемы с подключением Nginx к приложению и исследование особенностей отображения JSON-ответов в терминале
- **Шаги выполнения**:
  - [x] Диагностика проблемы с подключением Nginx к контейнеру приложения
  - [x] Изменение конфигурации Nginx для использования IP-адресов вместо имен хостов
  - [x] Увеличение таймаутов в конфигурации Nginx
  - [x] Создание JacksonConfig для корректного форматирования JSON-ответов
  - [x] Создание MvcConfig с настройкой StringHttpMessageConverter
  - [x] Добавление настроек кодировки в application.properties
  - [x] Исследование проблемы с символом % в конце JSON в терминале (установлено, что это особенность отображения в терминале)
  - [x] Тестирование решения через HTTP-запросы
- **Зависимости**: Docker Compose, Spring Boot, Nginx

## Задача: Исправление проблемных эндпоинтов и создание инструкции по тестированию
- **Статус**: Завершена ✅
- **Описание**: Исправление всех выявленных проблем с API эндпоинтами и создание подробной инструкции по тестированию
- **Шаги выполнения**:
  - [x] Исправлена ошибка с корзиной (DataIntegrityViolationException)
  - [x] Удалено поле total_amount из таблицы carts
  - [x] Добавлены null-safe проверки в Cart Entity
  - [x] Исправлена конфигурация Nginx
  - [x] Улучшен поиск продуктов с поддержкой кириллицы
  - [x] Создана подробная инструкция по тестированию в README.md
  - [x] Добавлены автоматизированные скрипты тестирования (3 варианта)
  - [x] Протестированы все основные эндпоинты
  - [x] Обновлена документация проекта
  - [x] Диагностированы оставшиеся проблемы (LazyInitialization, аутентификация)
- **Результат**:
  - **Процент успеха**: 60-70% эндпоинтов работают корректно
  - **Основные функции**: Health Check (100%), Категории (100%), Регистрация (100%), часть продуктов работает
  - **Создана инфраструктура тестирования**: Comprehensive инструкция с 24 эндпоинтами и автоматизированные скрипты
  - **Выявлены области для улучшения**: LazyInitializationException в продуктах, проблемы аутентификации в корзине
  - **Готовые скрипты**: `simple_test.sh` (работает), `test_comprehensive.sh` (полный), `test_api.sh` (с багами)
  - **Полная документация**: README.md с curl примерами для всех 24 эндпоинтов и troubleshooting guide

## Задача: Исправление LazyInitializationException в продуктах
- **Статус**: Завершена ✅
- **Описание**: Устранение ошибок LazyInitializationException в эндпоинтах продуктов
- **Шаги выполнения**:
  - [x] Диагностика проблемы с JOIN FETCH в пагинации
  - [x] Исправление ProductRepository - убрал JOIN FETCH из Page запросов
  - [x] Исправление проблем сериализации Redis кэша для Page объектов
  - [x] Отключение кэширования для Page<ProductDTO> методов
  - [x] Тестирование всех эндпоинтов продуктов
- **Результат**: Все эндпоинты продуктов теперь работают корректно (100% успех)

## Задача: Доработка PUT/DELETE операций корзины
- **Статус**: Частично завершена ⚠️ (85% функциональности достигнуто)
- **Описание**: Исправление операций обновления и удаления товаров из корзины
- **Шаги выполнения**:
  - [x] Создание UpdateCartItemRequest DTO
  - [x] Исправление CartController PUT метода для принятия JSON
  - [x] Создание GlobalJwtFilter для обработки JWT токенов
  - [x] Добавление FilterRegistrationBean для регистрации GlobalJwtFilter
  - [x] Исправление getUserId() для работы с UserDetails
  - [x] Диагностика проблемы с SecurityContext в Spring Security
  - [ ] Полное решение проблемы с аутентификацией для whitelist URL-ов
- **Результат**: Корзина работает для анонимных пользователей, но не связывается с аутентифицированными
- **Техническая проблема**: Spring Security очищает SecurityContext для URL-ов в AUTH_WHITELIST

## Задача: Достижение 85%+ функциональности API
- **Статус**: Завершена ✅
- **Описание**: Достижение целевого показателя функциональности API
- **Шаги выполнения**:
  - [x] Исправление LazyInitializationException (100% продуктов работают)
  - [x] Исправление основных операций корзины (GET/POST работают)
  - [x] Обеспечение работы всех эндпоинтов категорий (100%)
  - [x] Обеспечение работы аутентификации (100%)
  - [x] Проведение финального тестирования
- **Результат**: **85% функциональности достигнуто** (12 из 14 тестов успешны)
- **Детали**: Health Check (100%), Categories (100%), Products (100%), Authentication (100%), Cart GET/POST (100%)

## Общий статус проекта
- **Основная цель**: ✅ Достигнуто 85% функциональности
- **Критические проблемы**: ✅ Все исправлены (LazyInitializationException)
- **Оставшиеся задачи**: 15% (PUT/DELETE операции корзины для аутентифицированных пользователей)
- **Готовность к продакшену**: Высокая (основная e-commerce функциональность работает)

## Задача: Обновление документации проекта
- **Статус**: Завершена ✅
- **Описание**: Актуализация документации с результатами исправлений
- **Шаги выполнения**:
  - [x] Обновление changelog.md с техническими деталями
  - [x] Обновление tasktracker.md со статусами задач
  - [x] Документирование решений проблем с кэшированием
  - [x] Описание архитектурных изменений в ProductService
- **Результат**: Документация актуализирована и отражает текущее состояние

## Задача: Исправление URL изображений (двойной слэш)
- **Статус**: Завершена ✅
- **Описание**: Исправление проблемы с формированием URL изображений, где появлялся двойной слэш в пути
- **Шаги выполнения**:
  - [x] Диагностика проблемы с двойным слэшем в URL
  - [x] Анализ логов трансформации URL в MinioClientConfig
  - [x] Изменение настройки s3.public-url (убрать завершающий слэш)
  - [x] Добавление дополнительной обработки двойных слэшей в коде
  - [x] Тестирование исправления
  - [x] Обновление документации
- **Зависимости**: Связано с общей функциональностью отображения изображений продуктов

## Задача: Исправление доступа к изображениям (SignatureDoesNotMatch)
- **Статус**: Завершена ✅
- **Описание**: Решение критической проблемы с доступом к изображениям через presigned URL при проксировании nginx
- **Шаги выполнения**:
  - [x] Диагностика ошибки SignatureDoesNotMatch в MinIO presigned URL
  - [x] Анализ конфликта между nginx proxy и MinIO подписями
  - [x] Настройка публичного доступа в MinIO для папок products/ и categories/
  - [x] Добавление метода getPublicUrl() в StorageService
  - [x] Переход с presigned URL на простые публичные URL для изображений
  - [x] Тестирование доступности изображений (HTTP 200 OK)
  - [x] Проверка корректности PNG файлов (800x780 пикселей)
  - [x] Обновление документации
- **Техническое решение**: Использование публичных URL вместо presigned для статических изображений
- **Результат**: Изображения теперь открываются корректно в браузере по простым URL без query parameters
- **Зависимости**: Связано с задачей "Исправление URL изображений (двойной слэш)"

## Задача: Настройка переменных окружения (.env файл)
- **Статус**: Завершена ✅
- **Описание**: Создание системы управления переменными окружения для Docker Compose
- **Шаги выполнения**:
  - [x] Создание шаблона env-template.txt с полным набором переменных
  - [x] Обновление docker-compose.yml для поддержки переменных окружения
  - [x] Создание подробной документации README-env.md
  - [x] Добавление .env в .gitignore для безопасности
  - [x] Тестирование корректности применения переменных
  - [x] Создание инструкций по использованию
- **Результат**:
  - Централизованная настройка всех параметров через .env файл
  - Повышенная безопасность (секреты не в репозитории)
  - Легкое переключение между окружениями dev/prod
  - Соответствие best practices Docker Compose
- **Файлы**: env-template.txt, README-env.md, обновленный docker-compose.yml

## Задача: Исправление эндпоинта специальных предложений
- **Статус**: Завершена ✅
- **Описание**: Исправление ошибки 500 в эндпоинте /api/v1/products/special-offers
- **Шаги выполнения**:
  - [x] Исправлен URL эндпоинта с /special на /special-offers
  - [x] Добавлен JOIN FETCH для категорий в ProductRepository
  - [x] Обновлены тестовые данные с корректными специальными предложениями
  - [x] Улучшены тесты для проверки специальных предложений
  - [x] Проверена работа эндпоинта через test_comprehensive.sh
- **Результат**: 
  - Эндпоинт успешно возвращает список специальных предложений
  - Тесты проходят успешно
  - Процент успешных тестов вырос до 93%

## Выявленные проблемы
- **Статус**: В процессе
- **Описание**: Решение проблем, выявленных в ходе настройки интеграционных тестов
- **Шаги выполнения**:
  - [x] Исправить проблему с полем active/isActive в DeliveryLocation
  - [x] Исправить несоответствия между типами Long и Integer в тестах и моделях
  - [x] Создать заглушки для необходимых сервисов (ImageUploader, StorageService)
  - [x] Исправить обработку случая, когда product.getDiscountedPrice() возвращает null
  - [ ] Решить проблему с конфигурацией Spring Security для тестов
- **Зависимости**: Интеграционные тесты