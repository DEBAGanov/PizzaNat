# PizzaNat - Журнал изменений

## [2023-06-10] - Инициализация проекта

### Добавлено
- Создана базовая структура проекта Spring Boot
- Настроена интеграция с базой данных PostgreSQL
- Добавлены основные модели данных (User, Role, Product, Category)
- Настроена базовая аутентификация с использованием JWT

### Изменено
- Настроен процесс сборки с использованием Gradle
- Добавлена конфигурация Docker и Docker Compose для локальной разработки

### Исправлено
- Исправлены проблемы с миграциями базы данных

## [2023-07-01] - Реализация основного функционала

### Добавлено
- Разработаны API для управления продуктами и категориями
- Добавлен модуль корзины для пользователей
- Реализована система заказов с отслеживанием статусов
- Добавлена интеграция с MinIO для хранения изображений

### Изменено
- Улучшена система безопасности и авторизации
- Оптимизированы запросы к базе данных
- Добавлено кэширование с использованием Redis

### Исправлено
- Исправлены проблемы с обработкой транзакций
- Улучшена обработка ошибок в API

## [2023-08-05] - Расширение функциональности и оптимизация

### Добавлено
- Интеграция с Redis для кэширования
- Реализация механизма инвалидации кэша
- Добавлен модуль для работы с точками доставки
- Настроена документация API с использованием OpenAPI

### Изменено
- Улучшена обработка ошибок и валидация данных
- Оптимизированы запросы к БД для повышения производительности

### Исправлено
- Исправлены ошибки при параллельной работе с корзиной
- Устранены проблемы с загрузкой изображений

## [2023-09-20] - Повышение отказоустойчивости

### Добавлено
- Настроен мониторинг основных компонентов
- Добавлен механизм повторных попыток для внешних сервисов
- Реализована система уведомлений о критических ошибках

### Изменено
- Улучшена конфигурация для продакшн-окружения
- Оптимизированы настройки подключения к базе данных

### Исправлено
- Устранены проблемы с подключением к Redis
- Исправлены ошибки при обработке больших объемов данных

## [2023-10-15] - Административный интерфейс и оптимизация

### Добавлено
- Расширены возможности административного API
- Добавлены специальные предложения для продуктов
- Реализовано формирование отчетов по заказам

### Изменено
- Оптимизирована производительность API
- Улучшена система логирования

### Исправлено
- Исправлены проблемы с обновлением JWT-токенов
- Устранены ошибки в расчете стоимости заказов

## [2023-11-01] - Повышение отказоустойчивости и интеграция с платежной системой

### Добавлено
- Реализована интеграция с платежной системой Robokassa
- Внедрен Resilience4j для обеспечения отказоустойчивости внешних вызовов
- Добавлены Circuit Breaker и Retry паттерны для работы с внешними сервисами
- Реализованы эндпоинты для создания URL оплаты и обработки уведомлений от платежной системы
- Добавлен базовый класс BaseResilientClient для реализации отказоустойчивых клиентов

### Изменено
- Улучшена конфигурация RestTemplate для HTTP-клиентов
- Настроены таймауты для всех внешних вызовов
- Обновлены параметры в application.properties для поддержки отказоустойчивости
- Расширен OrderService для интеграции с платежной системой

### Исправлено
- Устранены потенциальные проблемы при недоступности внешних сервисов

## [2025-05-22] - Улучшение документации API

### Добавлено
- Создан конфигурационный класс OpenApiConfig для улучшения Swagger UI
- Добавлены подробные описания для всех API эндпоинтов
- Настроена аутентификация JWT в Swagger UI для удобного тестирования

### Изменено
- Обновлена конфигурация Swagger UI для более удобного использования
- Добавлены примеры запросов и ответов для основных эндпоинтов

### Исправлено
- Улучшено отображение документации API в браузере

## [2025-05-23] - Исправление проблем со Swagger и запуском приложения

### Добавлено
- Обновлена версия SpringDoc с 2.5.0 до 2.7.0 для совместимости с Spring Boot 3.4.5
- Добавлен /api/health в список разрешенных URL-адресов для доступа без аутентификации
- Создана правильная конфигурация OpenAPI с явным указанием версии "3.0.1"
- Добавлен SwaggerController для обработки перенаправлений и справочной страницы API
- Добавлены корневой путь "/" и "/api-help" в whitelist для доступа без аутентификации

### Изменено
- Изменен маппинг HomeController с корневого пути "/" на "/api/health" для избежания конфликта со Swagger UI
- Обновлена конфигурация Nginx для использования имен сервисов Docker вместо хардкодированных IP-адресов
- Упрощена конфигурация SpringDoc в application.properties
- Удален устаревший OpenApiConfig.java (заменен на новый с правильной конфигурацией)
- Удален атрибут version из docker-compose.yml
- Разделена ответственность между OpenApiConfig (основная конфигурация) и SwaggerConfig (группировки API)
- Исправлены дублирующие настройки в application.properties

### Исправлено
- Устранен конфликт между HomeController и Swagger UI на корневом пути "/"
- Исправлена ошибка NoSuchMethodError в ControllerAdviceBean при инициализации SpringDoc
- Исправлена проблема с доступом к health endpoint через настройки безопасности
- Решена проблема "Unable to render this definition" в Swagger UI путем правильной настройки версии OpenAPI
- Устранен конфликт дублирующих бинов OpenAPI между конфигурационными классами
- Исправлена проблема с кодировкой JSON в OpenAPI документации
- Полностью решена проблема с отображением API документации в Swagger UI

### Результат
- Приложение успешно запускается без ошибок
- Swagger UI полностью функционален и доступен по http://localhost/swagger-ui/index.html
- OpenAPI документация корректно отображается с версией 3.0.1
- API документация содержит все необходимые endpoint'ы с правильными описаниями, разделенными по группам:
  - Административное API
  - Все API
  - Клиентское API
  - Публичное API
- Health endpoint доступен по http://localhost/api/health
- Корневой путь "/" автоматически перенаправляет на Swagger UI
- Все проблемы с отображением и загрузкой Swagger UI полностью решены

## [2025-05-23] - Достижение 85% функциональности API - Исправление LazyInitializationException и улучшение корзины

### Исправлено
- **LazyInitializationException в ProductRepository**: Убрал JOIN FETCH из запросов с пагинацией (Page<Product>), так как это вызывало конфликты
- **Проблемы сериализации Redis кэша**: Отключил кэширование для методов, возвращающих Page объекты, оставил только для List и отдельных объектов
- **PUT операции корзины**: Исправил CartController для принятия JSON в теле запроса вместо RequestParam
- **Создан UpdateCartItemRequest DTO**: Добавлен недостающий DTO для обновления количества товара в корзине
- **GlobalJwtFilter**: Создан глобальный фильтр для обработки JWT токенов для всех запросов, включая whitelist

### Изменено
- **ProductRepository**: Убрал JOIN FETCH из методов findAllByIsAvailableTrue, findByCategoryIdAndIsAvailableTrue, searchProducts
- **ProductService**: Отключил кэширование для Page<ProductDTO> методов, оставил только для отдельных объектов
- **CartController**: Изменил PUT метод для принятия JSON в теле запроса
- **SecurityConfig**: Добавил FilterRegistrationBean для GlobalJwtFilter с порядком выполнения -100
- **CartController.getUserId()**: Добавил поддержку получения User по username через UserService

### Добавлено
- **UpdateCartItemRequest DTO**: Новый DTO для обновления количества товара в корзине с валидацией
- **GlobalJwtFilter**: Глобальный фильтр для обработки JWT токенов независимо от Spring Security whitelist
- **Детальное логирование**: Добавлено логирование в CartController и фильтры для диагностики проблем аутентификации

### Результаты тестирования
- **Процент успеха**: 85% (12 из 14 тестов)
- **Исправлены**: Все LazyInitializationException ошибки
- **Работают**: Health Check (100%), Categories (100%), Products (100%), Authentication (100%), Cart GET/POST (100%)
- **Частично работают**: Cart PUT/DELETE операции (проблема с сессиями аутентифицированных пользователей)

### Техническая диагностика
- **Основная проблема**: Spring Security очищает SecurityContext для URL-ов в AUTH_WHITELIST
- **Решение**: GlobalJwtFilter обрабатывает JWT токены, но SecurityContext не передается в контроллеры для whitelist URL-ов
- **Статус**: Корзина работает для анонимных пользователей, но не связывается с аутентифицированными пользователями

### Зависимости
- Связано с задачей "Доработка PUT/DELETE операций корзины"

## [2025-05-23] - Исправление проблемы с двойным слэшем в URL изображений

### Исправлено
- **Двойной слэш в URL изображений**: Исправлена проблема с формированием URL изображений, где появлялся двойной слэш (//localhost//pizzanat/...)
- **Конфигурация MinIO URL**: Изменена настройка `s3.public-url` с `http://localhost/` на `http://localhost` для корректной замены URL
- **Трансформация URL**: Добавлена дополнительная обработка двойных слэшей в `MinioClientConfig.minioUrlTransformer()`

### Техническая информация
- Проблема возникала при замене внутреннего URL MinIO (`http://minio:9000`) на публичный URL (`http://localhost/`)
- Исходный URL: `http://minio:9000/pizzanat/products/image.png`
- Результат до исправления: `http://localhost//pizzanat/products/image.png` (двойной слэш)
- Результат после исправления: `http://localhost/pizzanat/products/image.png` (корректный URL)

## [2025-05-23] - Полное исправление доступа к изображениям

### Исправлено
- **Проблема SignatureDoesNotMatch**: Исправлена критическая проблема с подписями presigned URL при проксировании через nginx
- **Переход на публичные URL**: Изменен подход с presigned URL на простые публичные URL для изображений продуктов и категорий
- **Настройка публичного доступа MinIO**: Настроен публичный доступ для папок `products/` и `categories/` в MinIO
- **Обновление StorageService**: Добавлен метод `getPublicUrl()` для генерации простых URL без подписей

### Техническая реализация
- **Корневая причина**: MinIO presigned URL содержат подпись, вычисленную для конкретного хоста. При проксировании nginx меняет заголовки и подпись становится недействительной
- **Решение**: Использование публичных URL вместо presigned для статических изображений
- **MinIO команды**: `mc anonymous set download local/pizzanat/products` - настройка публичного доступа
- **Новый формат URL**: `http://localhost/pizzanat/products/pizza_margarita.png` (простой, без query parameters)

### Результат
- **До исправления**: `SignatureDoesNotMatch` ошибка при переходе по URL изображений
- **После исправления**: Изображения открываются корректно в браузере (HTTP 200 OK, Content-Type: image/png)
- **Проверено**: PNG изображения размером 800x780 пикселей загружаются без ошибок

## [2025-05-23] - Настройка переменных окружения (.env файл)

### Добавлено
- **Шаблон .env файла**: Создан `env-template.txt` с полным набором переменных окружения
- **Обновленный docker-compose.yml**: Добавлена поддержка переменных окружения из .env файла
- **README-env.md**: Подробная инструкция по настройке и использованию переменных окружения
- **Безопасность**: Добавлен .env в .gitignore для предотвращения случайного коммита

### Переменные окружения
- **Безопасность**: DB_PASSWORD, REDIS_PASSWORD, JWT_SECRET, MINIO_ROOT_USER/PASSWORD
- **Приложение**: SPRING_PROFILES_ACTIVE, S3_PUBLIC_URL, SERVER_PORT
- **Почта**: MAIL_HOST, MAIL_USERNAME, MAIL_PASSWORD, NOTIFICATION_ENABLED
- **Платежи**: ROBOKASSA_MERCHANT_LOGIN, ROBOKASSA_PASSWORD1/2, ROBOKASSA_TEST_MODE
- **Docker**: Версии образов (POSTGRES_VERSION, REDIS_VERSION, MINIO_VERSION, NGINX_VERSION)
- **Мониторинг**: HEALTH_CHECK_INTERVAL, HEALTH_CHECK_TIMEOUT, HEALTH_CHECK_RETRIES

### Преимущества
- **Безопасность**: Секретные данные не хранятся в репозитории
- **Гибкость**: Легкое переключение между окружениями (dev/prod)
- **Удобство**: Централизованная настройка всех параметров
- **Стандартизация**: Соответствие best practices Docker Compose

### Инструкции по использованию
```bash
# Создание .env файла из шаблона
cp env-template.txt .env

# Редактирование под ваши потребности
nano .env

# Запуск с новыми переменными
docker compose up -d
```