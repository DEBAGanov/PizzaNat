# PizzaNat - Микросервис для заказа пиццы

## Содержание
1. [Обзор проекта](#обзор-проекта)
2. [Цели проекта](#цели-проекта)
3. [Архитектура](#архитектура)
4. [Технологический стек](#технологический-стек)
5. [Компоненты системы](#компоненты-системы)
6. [Модель данных](#модель-данных)
7. [API](#api)
8. [Безопасность](#безопасность)
9. [Масштабируемость и отказоустойчивость](#масштабируемость-и-отказоустойчивость)
10. [Деплой и инфраструктура](#деплой-и-инфраструктура)
11. [Мониторинг и логирование](#мониторинг-и-логирование)
12. [Дорожная карта развития](#дорожная-карта-развития)
13. [Стандарты разработки](#стандарты-разработки)
14. [Тестирование](#тестирование)
15. [Интеграция с Android приложением](#интеграция-с-android-приложением)
16. [Система аутентификации](#система-аутентификации)

## Обзор проекта

PizzaNat - это микросервис для заказа пиццы, который предоставляет полный функционал для работы онлайн-пиццерии. Проект разработан как основа для последующего масштабирования с добавлением мобильного приложения и веб-сайта.

Система обеспечивает следующие основные возможности:
- Управление каталогом продуктов (пиццы, напитки, десерты)
- Управление корзиной пользователя
- Оформление и отслеживание заказов
- **Многоканальная аутентификация** (email/пароль, SMS, Telegram)
- Управление доставкой
- Административный интерфейс для управления всеми аспектами работы
- **Интеграция с Android приложением PizzaNatApp**

## Цели проекта

1. **Бизнес-цели**:
   - Создание полноценной системы для продажи пиццы онлайн
   - Обеспечение масштабируемости для роста бизнеса
   - Повышение удовлетворенности клиентов через удобный процесс заказа
   - **Упрощение процесса регистрации и входа для пользователей**

2. **Технические цели**:
   - Разработка отказоустойчивой архитектуры
   - Минимизация операционных расходов на инфраструктуру
   - Обеспечение высокой производительности и быстрого отклика системы
   - Защита данных пользователей и бизнес-информации
   - Создание основы для интеграции с мобильными и веб-клиентами
   - **Реализация современных методов аутентификации**

## Архитектура

PizzaNat использует микросервисную архитектуру, основанную на принципах Domain-Driven Design (DDD) и **SOLID**. В текущей реализации представлен первый монолитный микросервис, который в дальнейшем может быть разделен на более специализированные сервисы.

### Архитектурные принципы

1. **Разделение ответственности (SoC)** - каждый компонент отвечает за конкретную бизнес-функцию
2. **Изоляция данных** - каждый микросервис имеет свое хранилище данных
3. **API-First подход** - все взаимодействия осуществляются через четко определенные API
4. **Горизонтальная масштабируемость** - возможность масштабирования каждого компонента независимо
5. **Отказоустойчивость** - система продолжает работать при отказе отдельных компонентов
6. **Принципы SOLID** - обеспечение поддерживаемости и расширяемости кода

### Уровни архитектуры

1. **Уровень представления**:
   - REST API контроллеры для взаимодействия с клиентами
   - Обработка запросов и формирование ответов
   - Валидация входных данных

2. **Бизнес-уровень**:
   - Сервисы, реализующие бизнес-логику
   - Транзакционное управление
   - Обработка бизнес-правил и ограничений

3. **Уровень доступа к данным**:
   - Репозитории для взаимодействия с базой данных
   - Кэширование данных
   - Управление постоянством объектов

4. **Уровень инфраструктуры**:
   - Конфигурация безопасности
   - Управление миграциями БД
   - Интеграция с внешними сервисами (хранилище файлов, email, SMS, Telegram)

## Технологический стек

### Бэкенд:
- **Язык программирования**: Java 17
- **Фреймворк**: Spring Boot 3.4.5
- **Управление зависимостями**: Gradle
- **Безопасность**: Spring Security, JWT
- **Доступ к данным**: Spring Data JPA, Hibernate
- **Кэширование**: Redis, Spring Cache
- **Миграции БД**: Flyway
- **Документация API**: SpringDoc OpenAPI 3.0 (простая стандартная конфигурация)
- **Отказоустойчивость**: Resilience4j

### Хранение данных:
- **СУБД**: PostgreSQL 15
- **Кэш**: Redis 7
- **Хранилище файлов**: MinIO (S3-совместимое)
- **Аналитика и отчеты**: Google Sheets (через Google Sheets API v4)

### Внешние интеграции:
- **SMS**: Exolve SMS API
- **Мессенджер**: Telegram Bot API
- **Email**: Spring Mail
- **Аналитика**: Google Sheets API v4
- **Платежи**: YooKassa API

### Инфраструктура:
- **Контейнеризация**: Docker, Docker Compose
- **Веб-сервер**: Nginx (для проксирования и SSL-терминации)

### Будущие компоненты:
- **Мониторинг**: Prometheus, Grafana
- **Трассировка**: Jaeger/Zipkin
- **Журналирование**: ELK Stack/Loki
- **Очереди сообщений**: Kafka/RabbitMQ

## Компоненты системы

### Основные модули

0. **Модуль Google Sheets интеграции**:
   - **Автоматическая синхронизация заказов** с Google Таблицами в реальном времени
   - **GoogleSheetsService** - основной сервис для работы с Google Sheets API v4
   - **GoogleSheetsEventListener** - обработчик событий заказов и платежей
   - **Event-driven архитектура** - использование Spring Events для автоматических обновлений
   - **Структурированные данные** - 16 колонок с полной информацией о заказах
   - **Умная сортировка** - новые заказы добавляются в начало таблицы
   - **Retry механизм** - автоматические повторы при сбоях Google Sheets API
   - **Асинхронная обработка** - операции не блокируют основной процесс

1. **Модуль аутентификации и авторизации**:
   - **Классическая аутентификация** (email/пароль)
   - **SMS аутентификация** (через Exolve API)
   - **Telegram аутентификация** (через Telegram Bot)
   - Управление ролями и разрешениями
   - Выдача и валидация JWT токенов

2. **Модуль управления продуктами**:
   - Управление каталогом продуктов
   - Категоризация продуктов
   - Управление ценами и акциями

3. **Модуль корзины**:
   - Добавление/удаление товаров
   - Расчет стоимости
   - Сохранение состояния корзины между сессиями
   - **Поддержка selectedOptions для Android**

4. **Модуль заказов**:
   - Создание заказов
   - Отслеживание статуса заказов
   - История заказов пользователя
   - **Поддержка deliveryAddress и notes для Android интеграции**

5. **Модуль доставки**:
   - Управление пунктами выдачи
   - **Автоматическое создание пунктов доставки из адресов**
   - Расчет стоимости доставки
   - Отслеживание доставки

6. **Административный модуль**:
   - Управление пользователями
   - Управление каталогом
   - Аналитика и отчеты

7. **Модуль нотификаций**:
   - Email-уведомления
   - **SMS-уведомления** (через Exolve)
   - **Telegram-уведомления** - уведомления о заказах в Telegram бот

8. **Модуль Telegram-интеграции**:
   - **Двухботовая архитектура**:
     - **@PizzaNatBot** (пользовательский бот) - авторизация пользователей и персональные уведомления
     - **@PizzaNatOrders_bot** (админский бот) - административные уведомления о заказах
   - **Аутентификация через Telegram бот** (@PizzaNatBot)
   - **Административные уведомления** о создании заказов (@PizzaNatOrders_bot)
   - **Административные уведомления** об изменении статуса заказов (@PizzaNatOrders_bot)
   - **Персональные уведомления** пользователям с Telegram ID (@PizzaNatBot)
   - Форматирование сообщений для удобного просмотра
   - Конфигурация Telegram Bot API для обоих ботов
   - **TelegramUserNotificationService** для персональных уведомлений пользователям
   - **PizzaNatAdminBot** для административных уведомлений сотрудникам
   - **Поддержка Long Polling и Webhook** для обработки команд и авторизации
   - **🆕 Telegram Mini App** - полнофункциональное веб-приложение по образцу @DurgerKingBot

9. **🆕 Модуль Telegram Mini App**:
   - **Полный UI интерфейс** с каталогом товаров, корзиной и оформлением заказов
   - **Автоматическая авторизация** через Telegram WebApp initData
   - **Адаптивный дизайн** с поддержкой тем Telegram
   - **Интеграция с YooKassa** для оплаты через СБП и банковские карты
   - **TelegramWebAppController** - REST API для работы с Mini App
   - **TelegramWebAppService** - сервис валидации и обработки WebApp данных
   - **Статические ресурсы** - HTML, CSS, JavaScript для фронтенда
   - **Direct Link поддержка** - https://t.me/DIMBOpizzaBot/DIMBO

10. **Модуль SMS-интеграции**:
   - **Отправка SMS кодов через Exolve API**
   - **Проверка SMS кодов для аутентификации**
   - Rate limiting для предотвращения спама
   - Логирование SMS операций

## Модель данных

### Ключевые сущности

1. **User** - пользователь системы
   - Основные атрибуты: id, username, password, email, firstName, lastName, phone
   - **Новые атрибуты**: phoneNumber, telegramId, telegramUsername, isPhoneVerified, isTelegramVerified
   - Связи: роли, заказы, корзина

2. **Role** - роль пользователя
   - Основные атрибуты: id, name
   - Связи: пользователи

3. **Product** - продукт (пицца, напиток и т.д.)
   - Основные атрибуты: id, name, description, price, imageUrl, weight, isAvailable, isSpecialOffer
   - Связи: категория, элементы корзины, элементы заказа

4. **Category** - категория продуктов
   - Основные атрибуты: id, name, description, imageUrl
   - Связи: продукты

5. **Cart** - корзина пользователя
   - Основные атрибуты: id, totalAmount
   - Связи: пользователь, элементы корзины

6. **CartItem** - элемент корзины
   - Основные атрибуты: id, quantity, price
   - **Новые атрибуты**: selectedOptions (для Android)
   - Связи: корзина, продукт

7. **Order** - заказ
   - Основные атрибуты: id, totalAmount, comment, contactName, contactPhone, createdAt, updatedAt
   - **Новые атрибуты**: deliveryAddress, notes (для Android интеграции)
   - Связи: пользователь, статус заказа, адрес доставки, элементы заказа

8. **OrderItem** - элемент заказа
   - Основные атрибуты: id, quantity, price
   - Связи: заказ, продукт

9. **OrderStatus** - статус заказа
   - Основные атрибуты: id, name, description
   - Связи: заказы

10. **DeliveryLocation** - пункт выдачи/доставки
    - Основные атрибуты: id, address, description, isActive
    - **Новые атрибуты**: latitude, longitude (nullable для автосозданных)
    - Связи: заказы

11. **SmsCode** - коды для SMS аутентификации
    - Основные атрибуты: id, phoneNumber, code, createdAt, expiresAt, used, attempts
    - Связи: -

12. **TelegramAuthToken** - токены для Telegram аутентификации
    - Основные атрибуты: id, authToken, telegramId, telegramUsername, telegramFirstName, telegramLastName, status, createdAt, expiresAt, confirmedAt
    - Связи: -

## API

### Основные эндпоинты

**Развернут на сервере**: https://debaganov-pizzanat-0177.twc1.net

1. **Аутентификация**:
   - `POST /api/v1/auth/register` - регистрация нового пользователя
   - `POST /api/v1/auth/login` - аутентификация пользователя
   - **`POST /api/auth/phone/send-code`** - отправка SMS кода
   - **`POST /api/auth/phone/verify-code`** - проверка SMS кода
   - **`POST /api/auth/telegram/init`** - инициализация Telegram аутентификации
   - **`GET /api/auth/telegram/status/{authToken}`** - статус Telegram аутентификации

2. **Категории**:
   - `GET /api/v1/categories` - получение всех категорий
   - `GET /api/v1/categories/{id}` - получение категории по ID

3. **Продукты**:
   - `GET /api/v1/products` - получение всех продуктов
   - `GET /api/v1/products/{id}` - получение продукта по ID
   - `GET /api/v1/products/category/{categoryId}` - получение продуктов по категории
   - `GET /api/v1/products/special-offers` - получение специальных предложений
   - `GET /api/v1/products/search?query=text` - поиск продуктов

4. **Корзина**:
   - `GET /api/v1/cart` - получение корзины пользователя
   - `POST /api/v1/cart/items` - добавление товара в корзину (с поддержкой selectedOptions)
   - `PUT /api/v1/cart/items/{productId}` - изменение количества товара
   - `DELETE /api/v1/cart/items/{productId}` - удаление товара из корзины

5. **Заказы** (поддержка Android интеграции):
   - `POST /api/v1/orders` - создание заказа
     * Поддержка `deliveryAddress` (Android) + автосоздание пунктов доставки
     * Поддержка `notes` как альтернативы `comment`
     * Гибкая валидация: либо `deliveryLocationId`, либо `deliveryAddress`
   - `GET /api/v1/orders` - получение всех заказов пользователя
   - `GET /api/v1/orders/{id}` - получение заказа по ID

6. **Доставка**:
   - `GET /api/v1/delivery-locations` - получение пунктов выдачи

7. **Административный API**:
   - `GET /api/v1/admin/orders` - получение всех заказов
   - `PUT /api/v1/admin/orders/{id}/status` - обновление статуса заказа
   - `POST /api/v1/admin/products` - создание продукта
   - `PUT /api/v1/admin/products/{id}` - обновление продукта
   - `DELETE /api/v1/admin/products/{id}` - удаление продукта

8. **Webhook эндпоинты**:
   - **`POST /api/telegram/webhook`** - webhook для Telegram бота

## Безопасность

### Принципы безопасности

1. **Аутентификация**:
   - JWT токены для авторизации API
   - **SMS код аутентификация** с rate limiting
   - **Telegram аутентификация** через официальный Bot API
   - Хеширование паролей BCrypt
   - Валидация всех входных данных

2. **Авторизация**:
   - Ролевая модель доступа (USER, ADMIN)
   - Проверка прав доступа на уровне методов
   - Изоляция данных между пользователями

3. **Rate Limiting**:
   - **SMS**: максимум 3 сообщения в час на номер
   - **Telegram**: максимум 5 токенов в час на IP
   - API endpoints: ограничения по пользователям

4. **Валидация данных**:
   - **Проверка формата номера телефона** (+7XXXXXXXXXX)
   - Санитизация входных данных
   - **CSRF защита для Telegram webhook**
   - XSS защита

5. **Защита данных**:
   - Шифрование конфиденциальных данных
   - Безопасное хранение JWT секретов
   - **Безопасное хранение SMS кодов с TTL**
   - **Защищенные Telegram токены**

## Интеграция с Android приложением

Проект интегрирован с мобильным приложением **PizzaNatApp** (https://github.com/DEBAGanov/PizzaNatApp).

### Особенности интеграции

1. **Расширенные модели заказов**:
   - Поддержка поля `deliveryAddress` для автоматического создания пунктов доставки
   - Поле `notes` как альтернатива `comment`
   - Гибкая валидация доставки

2. **Расширенная корзина**:
   - Поддержка `selectedOptions` для настроек товаров
   - Совместимость с Android API

3. **Автоматическое создание данных**:
   - Автосоздание DeliveryLocation из deliveryAddress
   - Координаты по умолчанию (Москва: 55.7558, 37.6173)

4. **Обратная совместимость**:
   - Все изменения сохраняют совместимость с веб-клиентами
   - Приоритет существующих полей над новыми

## Система аутентификации

PizzaNat поддерживает **многоканальную аутентификацию** для максимального удобства пользователей:

### 1. Классическая аутентификация (email/пароль)
- Стандартная регистрация с email и паролем
- JWT токены для авторизации API запросов
- Spring Security для защиты эндпоинтов
- Хеширование паролей с помощью BCrypt

### 2. SMS аутентификация (через Exolve API)

#### Архитектура SMS модуля
- **Entity**: `SmsCode` - хранение 4-значных кодов с TTL 10 минут
- **Service**: `SmsAuthService` - бизнес-логика отправки и проверки кодов
- **External API**: `ExolveService` - интеграция с Exolve SMS API
- **Rate Limiting**: Максимум 3 SMS в час на номер телефона

#### Процесс SMS аутентификации
1. Пользователь вводит номер телефона (+7XXXXXXXXXX)
2. Система генерирует 4-значный код и сохраняет в БД
3. Отправка SMS через Exolve API с текстом: "Ваш код для входа в PizzaNat: 1234"
4. Пользователь вводит код в приложении
5. Система проверяет код и создает/находит пользователя
6. Выдача JWT токена для авторизации

#### API эндпоинты SMS
- `POST /api/auth/phone/send-code` - отправка SMS кода
- `POST /api/auth/phone/verify-code` - проверка кода и авторизация

#### Конфигурация SMS
```properties
EXOLVE_API_URL=https://api.exolve.ru/messaging/v1
EXOLVE_API_KEY=your_api_key_here
EXOLVE_SENDER_NAME=PizzaNat
SMS_CODE_LENGTH=4
SMS_CODE_TTL_MINUTES=10
SMS_RATE_LIMIT_PER_HOUR=3
```

### 3. Telegram аутентификация (через Telegram Bot API)

#### Архитектура Telegram модуля
- **Entity**: `TelegramAuthToken` - хранение auth токенов с TTL 10 минут
- **Service**: `TelegramAuthService` - управление токенами и аутентификацией
- **Bot Integration**: Расширение `TelegramBotService` для обработки auth команд
- **Webhook**: Обработка callback от Telegram Bot API

#### Процесс Telegram аутентификации
1. Пользователь инициирует аутентификацию в приложении
2. Система генерирует уникальный auth_token (префикс "tg_auth_")
3. Создается ссылка: `https://t.me/pizzanat_bot?start=tg_auth_abc123`
4. Пользователь переходит по ссылке и подтверждает в боте
5. Бот отправляет webhook с данными пользователя
6. Система создает/находит пользователя по Telegram ID
7. Выдача JWT токена для авторизации

#### API эндпоинты Telegram
- `POST /api/auth/telegram/init` - инициализация аутентификации
- `GET /api/auth/telegram/status/{authToken}` - проверка статуса
- `POST /api/telegram/webhook` - webhook для обработки bot updates

#### Telegram Bot команды
- `/start tg_auth_abc123` - обработка auth токена
- Inline кнопки "✅ Подтвердить" / "❌ Отмена"
- Красивые сообщения с эмодзи для UX

#### Конфигурация Telegram
```properties
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_BOT_USERNAME=pizzanat_bot
TELEGRAM_WEBHOOK_URL=https://your-backend.com/api/telegram/webhook
TELEGRAM_AUTH_TOKEN_TTL_MINUTES=10
TELEGRAM_RATE_LIMIT_PER_HOUR=5
```

### 4. Безопасность аутентификации

#### Rate Limiting
- **SMS**: 3 сообщения в час на номер телефона
- **Telegram**: 5 токенов в час на IP адрес
- **Общий**: Защита от брутфорса на уровне Spring Security

#### Валидация данных
- Проверка формата российских номеров телефонов
- Санитизация всех входных данных
- CSRF защита для Telegram webhook
- Валидация JWT токенов на каждом запросе

#### Логирование безопасности
- Все попытки аутентификации (успешные и неуспешные)
- Ошибки интеграции с внешними API
- Подозрительная активность (превышение rate limits)
- Детальные логи для диагностики проблем

### 5. Модель данных аутентификации

#### Расширенная User entity
```java
// Поля для SMS аутентификации
private String phoneNumber;           // +7XXXXXXXXXX
private Boolean isPhoneVerified;      // Подтверждение SMS

// Поля для Telegram аутентификации
private Long telegramId;              // ID в Telegram
private String telegramUsername;      // @username
private Boolean isTelegramVerified;   // Подтверждение Telegram

// Методы для проверки аутентификации
public boolean hasVerifiedAuthentication();
public String getPrimaryIdentifier();
public String getDisplayName();
```

#### SmsCode entity
```java
private String phoneNumber;    // Номер телефона
private String code;          // 4-значный код
private LocalDateTime expiresAt;  // TTL 10 минут
private Boolean used;         // Флаг использования
private Integer attempts;     // Счетчик попыток
```

#### TelegramAuthToken entity
```java
private String authToken;           // tg_auth_abc123
private Long telegramId;           // ID пользователя
private String telegramUsername;   // Username
private TokenStatus status;        // PENDING/CONFIRMED/EXPIRED
private LocalDateTime expiresAt;   // TTL 10 минут
```

### 6. Интеграция с Android приложением

#### Совместимость API
- Универсальные JWT токены для всех типов аутентификации
- Расширение существующих DTO без breaking changes
- Поддержка всех методов в едином AuthResponse формате

#### Дополнительные поля для Android
- `deliveryAddress` - автоматическое создание пунктов доставки
- `selectedOptions` - поддержка настроек продуктов
- `notes` - дополнительные комментарии к заказу

#### Тестирование интеграции
- Обновленные скрипты `test_android_integration.sh`
- Проверка всех методов аутентификации
- Валидация совместимости с существующими клиентами

### 7. Мониторинг и метрики

#### Ключевые метрики
- Количество отправленных SMS по дням/часам
- Процент успешных аутентификаций по типам
- Время ответа Exolve и Telegram API
- Количество ошибок по категориям

#### Алерты и уведомления
- Превышение SLA внешних API (> 5 секунд)
- Высокий процент неуспешных аутентификаций (> 10%)
- Недоступность SMS/Telegram сервисов
- Подозрительная активность (массовые запросы)

### 8. Отказоустойчивость

#### Resilience4j интеграция
- **Circuit Breaker** для внешних API
- **Retry** с экспоненциальной задержкой
- **Timeout** для предотвращения зависания
- **Bulkhead** для изоляции ресурсов

#### Graceful Degradation
- Fallback на email аутентификацию при недоступности SMS
- Polling вместо webhook при проблемах с Telegram
- Кэширование результатов для снижения нагрузки
- Детальное логирование для быстрой диагностики

## Масштабируемость и отказоустойчивость

### Масштабируемость

1. **Горизонтальное масштабирование**:
   - Возможность запуска нескольких экземпляров сервиса
   - Балансировка нагрузки через Nginx

2. **Кэширование**:
   - Использование Redis для кэширования данных
   - Снижение нагрузки на базу данных

3. **Оптимизация базы данных**:
   - Индексирование часто используемых полей
   - Оптимизация запросов

### Отказоустойчивость

1. **Отказоустойчивость хранения данных**:
   - Репликация PostgreSQL
   - Резервное копирование данных

2. **Отказоустойчивость приложения**:
   - Механизм повторных попыток для внешних сервисов
   - Circuit Breaker для предотвращения каскадных сбоев

3. **Мониторинг и оповещение**:
   - Мониторинг ключевых метрик
   - Оповещение о сбоях и аномалиях

## Деплой и инфраструктура

### Локальная разработка

1. **Docker Compose**:
   - Запуск всех необходимых сервисов локально
   - Конфигурация для разработки

2. **Профили Spring**:
   - `dev` - для локальной разработки
   - `prod` - для продакшн-окружения

### Продакшн-окружение

1. **Контейнеризация**:
   - Docker-образы для всех компонентов
   - Оркестрация через Docker Compose (в будущем K8s)

2. **Балансировка нагрузки**:
   - Nginx как обратный прокси
   - SSL-терминация

3. **Мониторинг**:
   - Prometheus для сбора метрик
   - Grafana для визуализации

## Мониторинг и логирование

### Мониторинг

1. **Метрики приложения**:
   - Производительность API
   - Время отклика
   - Количество запросов

2. **Метрики системы**:
   - Использование CPU/RAM
   - Использование диска
   - Сетевая активность

### Логирование

1. **Уровни логирования**:
   - ERROR - критические ошибки
   - WARN - предупреждения
   - INFO - информационные сообщения
   - DEBUG - отладочная информация

2. **Централизованное хранение логов**:
   - Агрегация логов из всех экземпляров
   - Долгосрочное хранение

## Дорожная карта развития

### Версия 1.0 (Текущая)
- Базовый функционал заказа пиццы
- Авторизация и регистрация
- Управление корзиной и заказами
- Административный интерфейс

### Версия 1.1
- Интеграция с системами оплаты
- Расширенные отчеты для администраторов
- Улучшение системы уведомлений

### Версия 2.0
- Разделение на отдельные микросервисы
- API Gateway для единой точки входа
- Мобильное приложение

### Версия 3.0
- Веб-приложение для клиентов
- Программа лояльности
- Интеграция с CRM-системами

## Стандарты разработки

### Код

1. **Стиль кода**:
   - Следование Java Code Conventions
   - Использование Lombok для уменьшения шаблонного кода
   - Документирование классов и методов

2. **Архитектурные принципы**:
   - SOLID принципы
   - DRY (Don't Repeat Yourself)
   - KISS (Keep It Simple, Stupid)

3. **Тестирование**:
   - Модульные тесты для бизнес-логики
   - Интеграционные тесты для API
   - Тестирование с использованием Testcontainers

### Процесс разработки

1. **Контроль версий**:
   - Git Flow для управления ветками
   - Семантическое версионирование

2. **Code Review**:
   - Обязательное ревью кода перед слиянием
   - Автоматические проверки стиля и качества кода

3. **CI/CD**:
   - Автоматическая сборка
   - Автоматические тесты
   - Автоматический деплой

## Тестирование

### Интеграционные тесты

В проекте настроены интеграционные тесты для проверки работы основных контроллеров. Для тестирования используются:

- **H2** - встроенная база данных для тестов
- **Заглушки** для внешних сервисов (Redis, Mail, S3/MinIO)
- **Spring Security** с отключенной проверкой JWT для тестов

Основные компоненты тестовой инфраструктуры:
- `BaseIntegrationTest` - базовый класс для всех интеграционных тестов
- `TestConfig` - основная тестовая конфигурация
- `TestRedisConfig`, `TestMailConfig`, `TestS3Config` - заглушки для соответствующих сервисов
- `GlobalExceptionHandler` - обработчик исключений для API

### Обнаруженные проблемы

1. **Проблемы с конфигурацией Spring Security для тестов**
   - Тесты для CartController не проходят из-за проблем с авторизацией
   - Требуется дополнительная настройка для отключения проверки JWT в тестах

2. **Обработка null значений в расчетах**
   - В `CartService` и `CartItem` добавлена проверка на null для discountedPrice

3. **Несоответствие типов данных**
   - Исправлены несоответствия между типами Long и Integer в моделях и тестах

### Текущий статус тестов

- ✅ **AuthController** - все тесты проходят успешно
- ✅ **CategoryController** - все тесты проходят успешно
- ❌ **CartController** - тесты не проходят (проблемы с безопасностью)
- ❓ **ProductController** - тесты не настроены
- ❓ **OrderController** - тесты не настроены
- ❓ **PaymentController** - тесты не настроены

## Telegram интеграция

PizzaNat интегрирован с Telegram ботом для автоматических уведомлений о заказах.

### Функциональность
- 📱 Уведомления о новых заказах с полной информацией
- 🔄 Уведомления об изменении статуса заказов
- 💰 Информация о составе и стоимости заказа
- 👤 Контактная информация клиента

### Диагностические инструменты

#### 1. Автоматический тест интеграции
```bash
# Установите переменные окружения
export TELEGRAM_ENABLED=true
export TELEGRAM_BOT_TOKEN="ваш_токен"
export TELEGRAM_CHAT_ID="ваш_chat_id"

# Запустите полный тест
./test_telegram.sh
```

**Что тестирует:**
- ✅ Проверка переменных окружения
- ✅ Валидация токена бота
- ✅ Тестовая отправка сообщения
- ✅ Создание заказа с уведомлением
- ✅ Изменение статусов (CREATED → CONFIRMED → DELIVERING)

#### 2. Получение правильного chat_id
```bash
# Установите токен бота
export TELEGRAM_BOT_TOKEN="ваш_токен"

# Получите список доступных чатов
./get_telegram_chat_id.sh
```

**Что делает:**
- 🔍 Проверяет валидность токена бота
- 📨 Анализирует последние сообщения
- 📋 Показывает доступные chat_id
- 💡 Дает инструкции по настройке

### Настройка

1. **Создание бота:** [@BotFather](https://t.me/BotFather) → `/newbot`
2. **Получение chat_id:** `./get_telegram_chat_id.sh`
3. **Настройка переменных:**
   ```env
   TELEGRAM_ENABLED=true
   TELEGRAM_BOT_TOKEN=ваш_токен
   TELEGRAM_CHAT_ID=ваш_chat_id
   ```
4. **Тестирование:** `./test_telegram.sh`

### Диагностика ошибок

**"chat not found":**
- Убедитесь, что бот добавлен в чат/группу
- Проверьте правильность chat_id (для групп должен быть отрицательным)
- Используйте `./get_telegram_chat_id.sh` для получения правильного ID

**"unauthorized":**
- Проверьте токен бота в [@BotFather](https://t.me/BotFather)
- Убедитесь, что токен скопирован полностью

**Подробная документация:** [`TELEGRAM_SETUP.md`](../TELEGRAM_SETUP.md)

## API Документация

### Swagger UI

PizzaNat использует простую стандартную конфигурацию SpringDoc OpenAPI 3.0 для автоматической генерации и отображения документации API.

#### Доступ к документации

- **Swagger UI Interface**: [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **OpenAPI JSON Schema**: [http://localhost:8080/v3/api-docs](http://localhost:8080/v3/api-docs)
- **Автоматическое перенаправление**: с корневого пути `/` на Swagger UI

#### Особенности конфигурации

1. **Упрощенная архитектура**:
   - Удалены все кастомные конфигурации и статические ресурсы
   - Используется стандартная конфигурация SpringDoc без дополнительных настроек
   - Единственная зависимость: `springdoc-openapi-starter-webmvc-ui:2.7.0`

2. **Безопасность**:
   - JWT авторизация через header `Authorization: Bearer <token>`
   - Swagger UI доступен без авторизации для удобства разработки
   - Все эндпоинты корректно отображают требования к авторизации

3. **Автоматическая генерация**:
   - Все контроллеры автоматически документируются
   - Поддержка аннотаций `@Operation`, `@Tag`, `@Hidden`
   - Корректное отображение моделей данных и валидации

#### Тестирование эндпоинтов

Для проверки работы всех эндпоинтов используйте:
```bash
./test_swagger_endpoints.sh
```

**Что проверяется:**
- ✅ Доступность Swagger UI и OpenAPI документации
- ✅ Работа системных эндпоинтов (health check, корневой путь)
- ✅ Публичные эндпоинты (продукты, категории, пункты доставки)
- ✅ Защищенные эндпоинты (корзина, заказы, админ панель)
- ✅ Эндпоинты аутентификации (классическая, SMS, Telegram)

### Примеры Android интеграции