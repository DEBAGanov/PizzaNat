# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É –ÆKassa –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ÆKassa –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π —Å –ø–æ–º–æ—â—å—é –º–µ—Ç—Ä–∏–∫, –∞–ª–µ—Ä—Ç–æ–≤ –∏ –¥–∞—à–±–æ—Ä–¥–æ–≤.

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 1. –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
- **PaymentMetricsService** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
- **MetricsConfig** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Micrometer –º–µ—Ç—Ä–∏–∫
- **Spring Boot Actuator** - –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã

### 2. –°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤
- **PaymentAlertService** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
- **Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
- **–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤

### 3. API –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **PaymentMetricsController** - REST API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
- **Prometheus endpoint** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **Health checks** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

## –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### –°—á–µ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
```
yookassa_payments_total - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π
yookassa_payments_success - –£—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
yookassa_payments_failure - –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
yookassa_payments_cancelled - –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
yookassa_payments_sbp - –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ –°–ë–ü
yookassa_payments_card - –ö–∞—Ä—Ç–æ—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
```

### Webhook –º–µ—Ç—Ä–∏–∫–∏
```
yookassa_webhook_received - –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
yookassa_webhook_processed - –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ webhook
yookassa_webhook_failed - –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook
```

### –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
```
yookassa_payments_creation_time - –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
yookassa_webhook_processing_time - –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook
yookassa_payments_completion_time - –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
```

### –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
```
yookassa_payments_conversion_rate - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (%)
yookassa_payments_average_amount - –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –ø–ª–∞—Ç–µ–∂–∞
yookassa_payments_last_hour_total - –ü–ª–∞—Ç–µ–∂–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
yookassa_payments_daily_by_status - –ü–ª–∞—Ç–µ–∂–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∑–∞ –¥–µ–Ω—å
```

## API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ endpoint'—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#### 1. Health Check
```http
GET /api/v1/payments/metrics/health
```
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –º–µ—Ç—Ä–∏–∫.

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "UP",
  "service": "payment-metrics",
  "timestamp": "2025-01-26T15:30:00",
  "version": "1.0.0"
}
```

#### 2. –°–≤–æ–¥–∫–∞ –º–µ—Ç—Ä–∏–∫
```http
GET /api/v1/payments/metrics/summary
Authorization: Bearer <admin-token>
```
–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∑–∞ 24 —á–∞—Å–∞.

**–û—Ç–≤–µ—Ç:**
```json
{
  "totalPayments": 150,
  "successfulPayments": 142,
  "failedPayments": 8,
  "conversionRate": 94.67,
  "totalAmount": 285000.00
}
```

#### 3. –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
```http
GET /api/v1/payments/metrics/details
Authorization: Bearer <admin-token>
```
–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã.

#### 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```http
GET /api/v1/payments/metrics/config
Authorization: Bearer <admin-token>
```
–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

#### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
```http
POST /api/v1/payments/metrics/refresh
Authorization: Bearer <admin-token>
```
–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫.

### Prometheus –º–µ—Ç—Ä–∏–∫–∏
```http
GET /actuator/prometheus
```
Endpoint –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Prometheus/Grafana.

## –°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤

### –¢–∏–ø—ã –∞–ª–µ—Ä—Ç–æ–≤

#### 1. –ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è
- **–ü–æ—Ä–æ–≥:** < 70%
- **–£—Å–ª–æ–≤–∏–µ:** –ú–∏–Ω–∏–º—É–º 5 –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **–ö—É–ª–¥–∞—É–Ω:** 30 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –∞–ª–µ—Ä—Ç–∞–º–∏

#### 2. –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫
- **–ü–æ—Ä–æ–≥:** > 10%
- **–£—Å–ª–æ–≤–∏–µ:** –ê–Ω–∞–ª–∏–∑ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
- **–î–µ–π—Å—Ç–≤–∏–µ:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram

#### 3. –ö—Ä—É–ø–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
- **–°–æ–∑–¥–∞–Ω–∏–µ:** > 10,000‚ÇΩ
- **–£—Å–ø–µ—à–Ω—ã–π:** > 15,000‚ÇΩ
- **–ù–µ—É–¥–∞—á–∞:** > 5,000‚ÇΩ

#### 4. –ó–∞–≤–∏—Å—à–∏–µ –ø–ª–∞—Ç–µ–∂–∏
- **–ü–æ—Ä–æ–≥:** > 30 –º–∏–Ω—É—Ç –≤ —Å—Ç–∞—Ç—É—Å–µ PENDING
- **–î–µ–π—Å—Ç–≤–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

#### 5. –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ—à–∏–±–∫–∏
- **–£—Å–ª–æ–≤–∏–µ:** –û—à–∏–±–∫–∏ –≤ PaymentMetricsService
- **–î–µ–π—Å—Ç–≤–∏–µ:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

–í `application.properties`:
```properties
# –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
yookassa.alerts.enabled=true
yookassa.alerts.low-conversion-threshold=70.0
yookassa.alerts.high-failure-threshold=10.0
yookassa.alerts.max-pending-minutes=30
yookassa.alerts.cooldown-minutes=30
yookassa.alerts.min-payments-for-analysis=5
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana Dashboard

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Prometheus
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'pizzanat-yookassa'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 15s
```

### 2. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–Ω–µ–ª–∏

#### –ü–∞–Ω–µ–ª—å "–û–±–∑–æ—Ä –ø–ª–∞—Ç–µ–∂–µ–π"
```promql
# –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π
sum(yookassa_payments_total)

# –£—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
sum(yookassa_payments_success)

# –ö–æ–Ω–≤–µ—Ä—Å–∏—è
(sum(yookassa_payments_success) / sum(yookassa_payments_total)) * 100
```

#### –ü–∞–Ω–µ–ª—å "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"
```promql
# –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
histogram_quantile(0.95, yookassa_payments_creation_time_bucket)

# –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook
histogram_quantile(0.95, yookassa_webhook_processing_time_bucket)
```

#### –ü–∞–Ω–µ–ª—å "–û—à–∏–±–∫–∏"
```promql
# –£—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫
(sum(yookassa_payments_failure) / sum(yookassa_payments_total)) * 100

# –û—à–∏–±–∫–∏ webhook
sum(yookassa_webhook_failed)
```

### 3. –ê–ª–µ—Ä—Ç—ã –≤ Grafana
```yaml
# –ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è
- alert: YookassaLowConversion
  expr: (sum(yookassa_payments_success) / sum(yookassa_payments_total)) * 100 < 70
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "–ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ÆKassa"

# –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫
- alert: YookassaHighFailureRate
  expr: (sum(yookassa_payments_failure) / sum(yookassa_payments_total)) * 100 > 10
  for: 5m
  labels:
    severity: critical
  annotations:
    summary: "–í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫ –ÆKassa"
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
./test_yookassa_monitoring.sh
```

### 2. –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint
curl http://localhost:8080/api/v1/payments/metrics/health

# –ü–æ–ª—É—á–µ–Ω–∏–µ Prometheus –º–µ—Ç—Ä–∏–∫
curl http://localhost:8080/actuator/prometheus | grep yookassa
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤
```bash
# –°–∏–º—É–ª—è—Ü–∏—è –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
curl -X POST http://localhost:8080/api/v1/payments \
  -H "Content-Type: application/json" \
  -d '{"orderId": 999, "amount": 6000, "method": "SBP"}'
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```properties
# Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞
spring.jpa.properties.hibernate.jdbc.batch_size=20
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true

# –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
```

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
```java
@Cacheable(value = "payment-metrics", key = "#root.methodName")
public PaymentMetricsSummary getMetricsSummary() {
    // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç
}
```

### 3. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
```properties
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞ –ø–æ—Ç–æ–∫–æ–≤
spring.task.execution.pool.core-size=8
spring.task.execution.pool.max-size=16
spring.task.execution.pool.queue-capacity=100
```

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
```java
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ batch –∑–∞–ø—Ä–æ—Å–æ–≤
@Query("SELECT p FROM Payment p WHERE p.createdAt BETWEEN :start AND :end")
List<Payment> findByCreatedAtBetween(LocalDateTime start, LocalDateTime end);
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```properties
# –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
logging.level.com.baganov.pizzanat.service.PaymentMetricsService=DEBUG
logging.level.com.baganov.pizzanat.service.PaymentAlertService=INFO
```

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
```java
log.info("üìä –ú–µ—Ç—Ä–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: —Ç–∏–ø={}, –∑–Ω–∞—á–µ–Ω–∏–µ={}, –≤—Ä–µ–º—è={}", 
         metricType, value, timestamp);
```

### 3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
docker logs pizzanat-app | grep "PaymentMetrics"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
watch -n 5 'curl -s http://localhost:8080/actuator/metrics/yookassa.payments.total'
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- –í—Å–µ admin endpoint'—ã —Ç—Ä–µ–±—É—é—Ç JWT —Ç–æ–∫–µ–Ω —Å —Ä–æ–ª—å—é ADMIN
- Health endpoint –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 2. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞
```properties
# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Actuator endpoints
management.endpoints.web.exposure.include=health,prometheus,metrics
management.endpoint.health.show-details=when-authorized
```

### 3. –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```java
// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
log.info("–ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω: ID={}, —Å—É–º–º–∞={}‚ÇΩ", payment.getId(), payment.getAmount());
// –ù–ï –ª–æ–≥–∏—Ä—É–µ–º: –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç, —Ç–æ–∫–µ–Ω—ã, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

## –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –í–∫–ª—é—á–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
export YOOKASSA_METRICS_ENABLED=true
export YOOKASSA_ALERTS_ENABLED=true

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤
export YOOKASSA_ALERTS_LOW_CONVERSION=75.0
export YOOKASSA_ALERTS_HIGH_FAILURE=5.0
```

### 2. Docker Compose
```yaml
services:
  pizzanat-app:
    environment:
      - YOOKASSA_METRICS_ENABLED=true
      - YOOKASSA_ALERTS_ENABLED=true
    ports:
      - "8080:8080"
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```yaml
# docker-compose.monitoring.yml
version: '3.8'
services:
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
  
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
```

## –ü–æ–∏—Å–∫ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1. –ú–µ—Ç—Ä–∏–∫–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
curl http://localhost:8080/api/v1/payments/metrics/health

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker logs pizzanat-app | grep "MetricsService"

# –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
curl -X POST http://localhost:8080/api/v1/payments/metrics/refresh \
  -H "Authorization: Bearer <token>"
```

#### 2. –ê–ª–µ—Ä—Ç—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram –±–æ—Ç–∞
curl http://localhost:8080/actuator/health

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–ª–µ—Ä—Ç–æ–≤
curl http://localhost:8080/api/v1/payments/metrics/config
```

#### 3. –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
SELECT query, mean_time, calls 
FROM pg_stat_statements 
WHERE query LIKE '%Payment%' 
ORDER BY mean_time DESC LIMIT 10;
```

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
```bash
# –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
./test_yookassa_monitoring.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
curl -w "@curl-format.txt" -s -o /dev/null \
  http://localhost:8080/api/v1/payments/metrics/summary
```

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ `/api/v1/payments/metrics/config`
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ÆKassa API

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 26.01.2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–ê–≤—Ç–æ—Ä:** AI Assistant 