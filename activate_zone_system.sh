#!/bin/bash

echo "üéâ –ê–ö–¢–ò–í–ê–¶–ò–Ø –ó–û–ù–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–´ –î–û–°–¢–ê–í–ö–ò PIZZANAT"
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
if curl -s http://localhost:8080/api/health > /dev/null; then
    echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
ZONES_COUNT=$(docker exec pizzanat-postgres-dev psql -U pizzanat_user -d pizzanat_db -t -c "SELECT COUNT(*) FROM delivery_zones WHERE is_active = true;" 2>/dev/null | xargs)

if [ "$ZONES_COUNT" -gt 0 ]; then
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç $ZONES_COUNT –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–æ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏"
else
    echo "‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∑–æ–Ω–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏"
    exit 1
fi

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–æ–Ω–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
echo "3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–æ–Ω–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã..."

# –¢–µ—Å—Ç 1: –î—Ä—É–∂–±–∞ (100‚ÇΩ)
RESPONSE1=$(curl -s -G "http://localhost:8080/api/v1/delivery/estimate" --data-urlencode "address=—É–ª–∏—Ü–∞ –î—Ä—É–∂–±—ã, 5" --data-urlencode "orderAmount=500")
ZONE1=$(echo $RESPONSE1 | jq -r '.zoneName // "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∑–æ–Ω–∞"')
COST1=$(echo $RESPONSE1 | jq -r '.deliveryCost // 200')

# –¢–µ—Å—Ç 2: –ü—Ä–æ–º—É–∑–µ–ª (300‚ÇΩ)
RESPONSE2=$(curl -s -G "http://localhost:8080/api/v1/delivery/estimate" --data-urlencode "address=–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è —É–ª–∏—Ü–∞, 10" --data-urlencode "orderAmount=500")
ZONE2=$(echo $RESPONSE2 | jq -r '.zoneName // "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∑–æ–Ω–∞"')
COST2=$(echo $RESPONSE2 | jq -r '.deliveryCost // 200')

# –¢–µ—Å—Ç 3: –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
RESPONSE3=$(curl -s -G "http://localhost:8080/api/v1/delivery/estimate" --data-urlencode "address=—É–ª–∏—Ü–∞ –î—Ä—É–∂–±—ã, 5" --data-urlencode "orderAmount=900")
ZONE3=$(echo $RESPONSE3 | jq -r '.zoneName // "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∑–æ–Ω–∞"')
COST3=$(echo $RESPONSE3 | jq -r '.deliveryCost // 200')
FREE3=$(echo $RESPONSE3 | jq -r '.isDeliveryFree // false')

echo ""
echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:"
echo "=========================="

SUCCESS_COUNT=0
TOTAL_TESTS=3

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤
if [ "$ZONE1" = "–î—Ä—É–∂–±–∞" ] && [ "$COST1" = "100.00" ]; then
    echo "‚úÖ –¢–µ—Å—Ç 1: –î—Ä—É–∂–±–∞ - $COST1‚ÇΩ"
    ((SUCCESS_COUNT++))
else
    echo "‚ùå –¢–µ—Å—Ç 1: $ZONE1 - $COST1‚ÇΩ (–æ–∂–∏–¥–∞–ª–æ—Å—å: –î—Ä—É–∂–±–∞ - 100.00‚ÇΩ)"
fi

if [ "$ZONE2" = "–ü—Ä–æ–º—É–∑–µ–ª" ] && [ "$COST2" = "300.00" ]; then
    echo "‚úÖ –¢–µ—Å—Ç 2: –ü—Ä–æ–º—É–∑–µ–ª - $COST2‚ÇΩ"
    ((SUCCESS_COUNT++))
else
    echo "‚ùå –¢–µ—Å—Ç 2: $ZONE2 - $COST2‚ÇΩ (–æ–∂–∏–¥–∞–ª–æ—Å—å: –ü—Ä–æ–º—É–∑–µ–ª - 300.00‚ÇΩ)"
fi

if [ "$ZONE3" = "–î—Ä—É–∂–±–∞" ] && [ "$COST3" = "0" ] && [ "$FREE3" = "true" ]; then
    echo "‚úÖ –¢–µ—Å—Ç 3: –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ - $COST3‚ÇΩ"
    ((SUCCESS_COUNT++))
else
    echo "‚ùå –¢–µ—Å—Ç 3: $ZONE3 - $COST3‚ÇΩ, –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è: $FREE3 (–æ–∂–∏–¥–∞–ª–æ—Å—å: –î—Ä—É–∂–±–∞ - 0.00‚ÇΩ, true)"
fi

echo ""
echo "üìà –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢: $SUCCESS_COUNT/$TOTAL_TESTS —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ"

if [ $SUCCESS_COUNT -eq $TOTAL_TESTS ]; then
    echo ""
    echo "üéâ –ó–û–ù–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –î–û–°–¢–ê–í–ö–ò –£–°–ü–ï–®–ù–û –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê!"
    echo "=================================================="
    echo ""
    echo "üìã –ù–ê–°–¢–†–û–ï–ù–ù–´–ï –ó–û–ù–´:"
    echo "‚Ä¢ –î—Ä—É–∂–±–∞: 100‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 800‚ÇΩ)"
    echo "‚Ä¢ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π: 200‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1000‚ÇΩ)"
    echo "‚Ä¢ –ú–∞—à–∏–Ω–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å: 200‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1000‚ÇΩ)"
    echo "‚Ä¢ –í–î–ö: 200‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1000‚ÇΩ)"
    echo "‚Ä¢ –°–µ–≤–µ—Ä–Ω—ã–π: 200‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1000‚ÇΩ)"
    echo "‚Ä¢ –ì–æ—Ä–≥–∞–∑: 200‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1000‚ÇΩ)"
    echo "‚Ä¢ –ü—Ä–∏–±—Ä–µ–∂–Ω—ã–π: 200‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1000‚ÇΩ)"
    echo "‚Ä¢ –ó–∞—Ä—è: 250‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1200‚ÇΩ)"
    echo "‚Ä¢ –õ—É–≥–æ–≤–∞—è: 250‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1200‚ÇΩ)"
    echo "‚Ä¢ –ú–∞–º–∞—Å–µ–≤–æ: 250‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1200‚ÇΩ)"
    echo "‚Ä¢ –ü—Ä–æ–º—É–∑–µ–ª: 300‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 1500‚ÇΩ)"
    echo ""
    echo "üåç –ü–æ–∫—Ä—ã—Ç–∏–µ: 210+ —É–ª–∏—Ü –≥–æ—Ä–æ–¥–∞ –í–æ–ª–∂—Å–∫"
    echo "‚è∞ –í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏: 30-60 –º–∏–Ω—É—Ç"
    echo "üïò –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: 09:00-22:00"
    echo ""
    echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!"
    exit 0
else
    echo ""
    echo "‚ö†Ô∏è  –ß–ê–°–¢–ò–ß–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø"
    echo "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."
    echo "–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤:"
    echo "docker logs pizzanat-app-dev | grep -E '(ERROR|Exception)'"
    exit 1
fi 