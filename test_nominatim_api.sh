#!/bin/bash

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Nominatim API –Ω–∞–ø—Ä—è–º—É—é
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ API OpenStreetMap –¥–ª—è –∞–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–æ–∫ –∞–¥—Ä–µ—Å–æ–≤

echo "üó∫Ô∏è  –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Nominatim API (OpenStreetMap)"
echo "=============================================="
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Nominatim
test_nominatim() {
    local query="$1"
    local description="$2"
    
    echo "üìç $description"
    echo "–ó–∞–ø—Ä–æ—Å: $query"
    
    # URL-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    encoded_query=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$query'))")
    
    url="https://nominatim.openstreetmap.org/search?q=${encoded_query}&format=json&limit=5&addressdetails=1&countrycodes=ru&bounded=1&viewbox=48.2,55.8,48.5,55.9"
    
    echo "URL: $url"
    
    response=$(curl -s -H "User-Agent: PizzaNat/1.0 (test@pizzanat.ru)" "$url")
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
        echo "–û—Ç–≤–µ—Ç:"
        echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        count=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data))" 2>/dev/null || echo "0")
        echo "–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: $count"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞"
    fi
    echo "----------------------------------------"
    echo ""
}

# –¢–µ—Å—Ç 1: –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –í–æ–ª–∂—Å–∫
echo "üîç –¢–µ—Å—Ç 1: –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –í–æ–ª–∂—Å–∫"
test_nominatim "Volzhsk" "–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –í–æ–ª–∂—Å–∫ (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π)"
test_nominatim "–í–æ–ª–∂—Å–∫" "–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –í–æ–ª–∂—Å–∫ (–∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π)"

# –¢–µ—Å—Ç 2: –ü–æ–∏—Å–∫ —É–ª–∏—Ü –≤ –í–æ–ª–∂—Å–∫–µ
echo "üîç –¢–µ—Å—Ç 2: –ü–æ–∏—Å–∫ —É–ª–∏—Ü –≤ –í–æ–ª–∂—Å–∫–µ"
test_nominatim "Volzhsk Lenin street" "–ü–æ–∏—Å–∫ —É–ª–∏—Ü—ã –õ–µ–Ω–∏–Ω–∞ –≤ –í–æ–ª–∂—Å–∫–µ"
test_nominatim "–í–æ–ª–∂—Å–∫ —É–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞" "–ü–æ–∏—Å–∫ —É–ª–∏—Ü—ã –õ–µ–Ω–∏–Ω–∞ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)"
test_nominatim "Volzhsk Sverdlova street" "–ü–æ–∏—Å–∫ —É–ª–∏—Ü—ã –°–≤–µ—Ä–¥–ª–æ–≤–∞"

# –¢–µ—Å—Ç 3: –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤
echo "üîç –¢–µ—Å—Ç 3: –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤"
test_nominatim "Volzhsk Lenin 1" "–ü–æ–∏—Å–∫ –¥–æ–º–∞ 1 –Ω–∞ —É–ª–∏—Ü–µ –õ–µ–Ω–∏–Ω–∞"
test_nominatim "–í–æ–ª–∂—Å–∫ –õ–µ–Ω–∏–Ω–∞ 10" "–ü–æ–∏—Å–∫ –¥–æ–º–∞ 10 –Ω–∞ —É–ª–∏—Ü–µ –õ–µ–Ω–∏–Ω–∞"

# –¢–µ—Å—Ç 4: –ü–æ–∏—Å–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–µ–≥–∏–æ–Ω–∞
echo "üîç –¢–µ—Å—Ç 4: –ü–æ–∏—Å–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–µ–≥–∏–æ–Ω–∞"
test_nominatim "Volzhsk, Mari El, Russia" "–ü–æ–∏—Å–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–µ–≥–∏–æ–Ω–∞"
test_nominatim "–í–æ–ª–∂—Å–∫, –ú–∞—Ä–∏–π –≠–ª, –†–æ—Å—Å–∏—è" "–ü–æ–∏—Å–∫ —Å —Ä–µ–≥–∏–æ–Ω–æ–º (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)"

# –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ API
echo "üîç –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
echo "–í—ã–ø–æ–ª–Ω—è–µ–º 5 –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥..."

for i in {1..5}; do
    echo -n "–ó–∞–ø—Ä–æ—Å $i: "
    start_time=$(date +%s%N)
    curl -s -H "User-Agent: PizzaNat/1.0" "https://nominatim.openstreetmap.org/search?q=Volzhsk&format=json&limit=1" > /dev/null
    end_time=$(date +%s%N)
    duration=$(( (end_time - start_time) / 1000000 ))
    echo "${duration}ms"
    sleep 1  # –°–æ–±–ª—é–¥–∞–µ–º –ª–∏–º–∏—Ç—ã API (1 –∑–∞–ø—Ä–æ—Å –≤ —Å–µ–∫—É–Ω–¥—É)
done

echo ""
echo "üéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Nominatim API –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "=============================================="
echo ""
echo "üìã –í—ã–≤–æ–¥—ã:"
echo "- Nominatim API –¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
echo "- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É –í–æ–ª–∂—Å–∫"
echo "- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"
echo "- –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–µ–π"
echo "- –ò–º–µ–µ—Ç –ª–∏–º–∏—Ç: 1 –∑–∞–ø—Ä–æ—Å –≤ —Å–µ–∫—É–Ω–¥—É"
echo ""
echo "üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:"
echo "- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
echo "- –î–æ–±–∞–≤–∏—Ç—å debounce –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞"
echo "- –°–æ–±–ª—é–¥–∞—Ç—å –ª–∏–º–∏—Ç—ã API (1 req/sec)"
echo "- –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –∞–¥—Ä–µ—Å–æ–≤" 