# üöÄ –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø–ú–ò –û–ë –û–ü–õ–ê–¢–ï –Æ–ö–∞—Å—Å–∞

**–î–∞—Ç–∞**: $(date '+%d.%m.%Y')  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ**

## üéØ –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞, –∏–∑-–∑–∞ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å—É:
- ‚ùå –ù–µ –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω—Å–∫–∏–π –±–æ—Ç (@DIMBOpizzaOrdersBot)
- ‚ùå –ù–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –≤ Google –¢–∞–±–ª–∏—Ü–µ

**–¢–µ–ø–µ—Ä—å –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!** ‚úÖ

## üîß –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
–í `YooKassaPaymentService` –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ webhook'–∞ –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–æ—Å—å —Å–æ–±—ã—Ç–∏–µ `PaymentStatusChangedEvent`, –∏–∑-–∑–∞ —á–µ–≥–æ Google Sheets –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—è `PaymentStatusChangedEvent` –≤ –º–µ—Ç–æ–¥ `updateOrderStatusAfterPayment()`:

```java
// –¢–µ–ø–µ—Ä—å –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –û–ë–ê —Å–æ–±—ã—Ç–∏—è:
eventPublisher.publishEvent(new PaymentStatusChangedEvent(...)); // –î–ª—è Google Sheets  
eventPublisher.publishEvent(new NewOrderEvent(...));              // –î–ª—è –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –±–æ—Ç–∞
```

## üöÄ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç:
1. **–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑** —á–µ—Ä–µ–∑ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram
2. **–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–ª–∞—Ç—É –°–ë–ü** –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥–º–∏–Ω—Å–∫–∏–π –±–æ—Ç** - –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ "‚úÖ –ó–ê–ö–ê–ó –û–ü–õ–ê–ß–ï–ù —á–µ—Ä–µ–∑ –°–ë–ü"  
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ [Google –¢–∞–±–ª–∏—Ü—É](https://docs.google.com/spreadsheets/d/1K_g-EGPQgu4aFv4bIPP6yE_raHyUrlr6GYi-MTEJtu4/edit?gid=0#gid=0)** - —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–º–µ–Ω–∏—Ç—å—Å—è —Å "–ù–µ –æ–ø–ª–∞—á–µ–Ω" –Ω–∞ –Ω—É–∂–Ω—ã–π —Å—Ç–∞—Ç—É—Å

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç:
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:
```bash
cd /Users/bagano/Downloads/Cursor/PizzaNat
./scripts/test_payment_webhook_notifications.sh
```

## üìä –ö–∞–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

**–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–µ:**

1. **–Æ–ö–∞—Å—Å–∞ ‚Üí Webhook** ‚Üí –í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ `payment.succeeded`
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞** ‚Üí –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `CONFIRMED`, —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –Ω–∞ `PAID`
3. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π**:
   - `PaymentStatusChangedEvent` ‚Üí **Google Sheets –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**  
   - `NewOrderEvent` ‚Üí **–ê–¥–º–∏–Ω—Å–∫–∏–π –±–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "‚úÖ –ó–ê–ö–ê–ó –û–ü–õ–ê–ß–ï–ù"**

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å—ë –µ—â–µ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:

#### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
```bash
# –û–±—â–∏–µ –ª–æ–≥–∏ webhook'–æ–≤ –æ—Ç –Æ–ö–∞—Å—Å—ã
docker-compose logs app | grep -i "webhook\|yookassa"

# –°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
docker-compose logs app | grep -E "PaymentStatusChangedEvent|NewOrderEvent|–ó–ê–ö–ê–ó –û–ü–õ–ê–ß–ï–ù"

# Google Sheets –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
docker-compose logs app | grep -i "GoogleSheets"
```

#### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Æ–ö–∞—Å—Å—ã:
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–ö–∞—Å—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω webhook:
- **URL**: `https://debaganov-pizzanat-0177.twc1.net/api/v1/payments/yookassa/webhook`
- **–°–æ–±—ã—Ç–∏—è**: 
  - ‚úÖ `payment.succeeded` - –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω
  - ‚úÖ `payment.canceled` - –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω

#### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:
```bash
# –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
curl -s https://debaganov-pizzanat-0177.twc1.net/actuator/health

# Google Sheets (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
curl -s https://debaganov-pizzanat-0177.twc1.net/api/v1/admin/google-sheets/status
```

## üìã –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- ‚úÖ `YooKassaPaymentService.java` - –¥–æ–±–∞–≤–ª–µ–Ω PaymentStatusChangedEvent
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `scripts/test_payment_webhook_notifications.sh`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ `PAYMENT_NOTIFICATIONS_FIX.md`

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- ‚úÖ Google Sheets –≤–∫–ª—é—á–µ–Ω—ã: `GOOGLE_SHEETS_ENABLED=true`
- ‚úÖ Webhook endpoint –Ω–∞—Å—Ç—Ä–æ–µ–Ω: `/api/v1/payments/yookassa/webhook`
- ‚úÖ –ê–¥–º–∏–Ω—Å–∫–∏–π –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω: `@DIMBOpizzaOrdersBot`

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ:**

1. **–ê–¥–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**: "‚úÖ –ó–ê–ö–ê–ó –û–ü–õ–ê–ß–ï–ù —á–µ—Ä–µ–∑ –°–ë–ü" –≤ –±–æ—Ç–µ @DIMBOpizzaOrdersBot
2. **Google –¢–∞–±–ª–∏—Ü–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**: –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ—Ç—Å—è  
3. **–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç**: –û–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π PaymentStatusChangedEvent –∏ NewOrderEvent

---

**üéâ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!**

**üìû –í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥ –≤—ã—à–µ –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
